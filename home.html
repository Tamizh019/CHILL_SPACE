<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chill Space</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  
  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --secondary: #f59e0b;
      --dark: #0f172a;
      --darker: #020617;
      --light: #f8fafc;
      --gray: #94a3b8;  
      --success: #10b981;
      --danger: #ef4444;
      --card-bg: rgba(15, 23, 42, 0.7);
      --card-border: rgba(148, 163, 184, 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }

    body {
      background: var(--darker);
      color: var(--light);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
      width: 100%;
      max-width: 100vw;
    }

    header {
      background: var(--dark);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--card-border);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      min-height: 60px;
      flex-shrink: 0;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    header h1 {
      font-size: 1.5rem;
      font-weight: 600;
      background: linear-gradient(to right, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .header-actions {
  display: flex;
  align-items: center;
  gap: 3.4rem;
  margin-left: auto; /* Pushes to the right */
}
.user-info {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  cursor: pointer;
}
#username {
  color: var(--text);
  font-weight: 500;
}

.user-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--primary);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  cursor: pointer;
}

    .user-avatar:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    .btn {
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      min-height: 44px;
      touch-action: manipulation;
    }

    .btn-primary {
      background: var(--primary);
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--secondary);
    }

    .btn-secondary:hover {
      background: #e67e22;
      transform: translateY(-1px);
    }

    .btn-danger {
      background: var(--danger);
    }

    .btn-danger:hover {
      background: #dc2626;
      transform: translateY(-1px);
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--gray);
      color: var(--gray);
    }

    .btn-outline:hover {
      border-color: var(--light);
      color: var(--light);
    }

    .btn-sm {
      padding: 0.25rem 0.75rem;
      font-size: 0.875rem;
    }

    .desktop-only {
      display: inline;
    }

    main {
      flex: 1;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 2rem;
      max-width: 1600px;
      margin: 0 auto;
      width: 100%;
      overflow-x: hidden;
    }

    /* Update main-content to be single column */
    .main-content {
      display: flex;
      flex-direction: column;
      gap: 2rem;
      width: 90%;
      max-width: 1600px;
      margin: 0 auto;
      overflow-x: hidden;
    }

    /* Chat container stays full width */
    .chat-container {
      width: 100%;
      height: 800px; 
      min-height: 600px;
    }

    .sidebar {
      max-width: 420px;
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 2rem;
      overflow-x: hidden;
    }

    .card {
      background: var(--card-bg);
      padding: 1.5rem;
      border-radius: 12px;
      border: 1px solid var(--card-border);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .card h2 {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--light);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .file-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .file-item {
      background: rgba(30, 41, 59, 0.5);
      padding: 0.8rem 1rem;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
      cursor: pointer;
      gap: 0.75rem;
      min-height: 60px;
      animation: fileSlideIn 0.4s ease-out;
    }

    .file-item:hover {
      background: rgba(30, 41, 59, 0.8);
      transform: translateX(2px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
      border: 1px solid rgba(99, 102, 241, 0.3);
    }

    @keyframes fileSlideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .file-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex: 1;
      min-width: 0; 
      overflow: hidden;
    }

    .file-icon {
      color: var(--secondary);
      flex-shrink: 0; 
    }

    .file-details {
      flex: 1;
      min-width: 0; 
      overflow: hidden;
    }

    .file-name {
      font-weight: 500;
      color: var(--light);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .file-meta {
      font-size: 0.75rem;
      color: var(--gray);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .file-actions {
      display: flex;
      gap: 0.5rem;
      flex-shrink: 0; 
    }

    .file-actions button {
      cursor: pointer;
      flex-shrink: 0;
    }

    .upload-area {
      position: relative;
      border: 2px dashed var(--gray);
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      transition: all 0.3s ease;
      margin-top: 1rem;
    }

    .upload-area:hover {
      border-color: var(--primary);
    }

    .upload-area input {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      opacity: 0;
      cursor: pointer;
    }

    .upload-area p {
      color: var(--gray);
      margin-top: 0.5rem;
      font-size: 0.875rem;
    }

    .file-preview {
      margin-top: 1rem;
      padding: 1rem;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 8px;
      border: 1px solid var(--card-border);
      max-height: 300px;
      overflow-y: auto;
    }

    .file-preview h4 {
      color: var(--light);
      margin-bottom: 0.75rem;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .preview-item {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.75rem;
      background: rgba(15, 23, 42, 0.3);
      border-radius: 8px;
      margin-bottom: 0.75rem;
      word-break: break-word;
      overflow-wrap: break-word;
      min-height: 60px;
      flex-wrap: wrap;
    }

    .preview-item:last-child {
      margin-bottom: 0;
    }

    .preview-icon {
      color: var(--secondary);
      font-size: 1.2rem;
    }

    .preview-info {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      max-width: calc(100% - 80px);
    }

    .preview-name {
      font-weight: 500;
      color: var(--light);
      font-size: 0.875rem;
      word-break: break-all;
      overflow-wrap: break-word;
      max-width: 120px;
      line-height: 1.3;
      white-space: normal;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .preview-size {
      font-size: 0.75rem;
      color: var(--gray);
    }

    .preview-image {
      max-width: 60px;
      max-height: 60px;
      border-radius: 4px;
      object-fit: cover;
    }

    .preview-remove {
      background: var(--danger);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      transition: all 0.2s ease;
      min-width: 32px;
      min-height: 32px;
      touch-action: manipulation;
    }

    .preview-remove:hover {
      background: #dc2626;
      transform: scale(1.1);
    }

    .no-files {
      color: var(--gray);
      font-style: italic;
      text-align: center;
      padding: 1rem;
    }

    .chat-container {
      display: flex;
      flex-direction: column;
      height: 800px;
      min-height: 600px;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      background: rgba(2, 6, 23, 0.5);
      border-radius: 8px;
      margin-bottom: 1rem;
      -webkit-overflow-scrolling: touch;
      scroll-behavior: smooth;
      scrollbar-width: thin;
      scrollbar-color: var(--gray) transparent;
      width: 100%;
      max-width: 100%;
    }

    .chat-messages::-webkit-scrollbar {
      width: 8px;
    }

    .chat-messages::-webkit-scrollbar-track {
      background: transparent;
      border-radius: 4px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: var(--gray);
      border-radius: 4px;
      transition: background 0.3s ease;
    }

    .chat-messages::-webkit-scrollbar-thumb:hover {
      background: var(--light);
    }

    .message {
      max-width: 80%;
      padding: 0.75rem 1rem;
      border-radius: 16px;
      position: relative;
      animation: messageSlideIn 0.3s ease-out;
      word-wrap: break-word;
      overflow-wrap: break-word;
      word-break: break-word;
    }

    @keyframes messageSlideIn {
      from {
        opacity: 0;
        transform: translateY(10px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .message-sent {
      align-self: flex-end;
      background: var(--primary);
      border-bottom-right-radius: 4px;
    }

    .message-received {
      align-self: flex-start;
      background: var(--dark);
      border-bottom-left-radius: 4px;
    }

    .message-sent:hover .message-delete {
      opacity: 1;
      visibility: visible;
    }

    .message-delete {
      position: absolute;
      top: -8px;
      right: -8px;
      background: var(--danger);
      border: none;
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      z-index: 10;
    }

    .message-delete:hover {
      background: #dc2626;
      transform: scale(1.1);
    }

    .message-content {
      position: relative;
    }

    .message-sender {
      font-weight: 600;
      font-size: 0.75rem;
      margin-bottom: 0.25rem;
      color: var(--secondary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .user-role {
      font-size: 0.7rem;
      padding: 0.1rem 0.4rem;
      border-radius: 12px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .role-admin {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .role-moderator {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .role-vip {
      background: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
      border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .role-user {
      background: rgba(251, 146, 60, 0.2);
      color: #fb923c;
      border: 1px solid rgba(251, 146, 60, 0.3);
    }

    .message-time {
      font-size: 0.65rem;
      color: var(--gray);
      text-align: right;
      margin-top: 0.25rem;
    }

    .chat-input {
      display: flex;
      gap: 0.5rem;
      position: relative;
      width: 100%;
      max-width: 100%;
    }

    .chat-input input {
      flex: 1;
      background: var(--dark);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 0.75rem 1rem;
      color: var(--light);
      min-height: 44px;
      font-size: 16px;
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }

    .chat-input input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .chat-input textarea {
      flex: 1;
      background: var(--dark);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 0.75rem 1rem;
      color: var(--light);
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
      line-height: 1.4;
      resize: vertical;
      min-height: 60px;
      max-height: 200px;
      font-size: 16px;
    }

    .chat-input textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    .chat-controls {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .code-toggle {
      background: var(--secondary);
      border: none;
      color: white;
      padding: 0.5rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
    }

    .code-toggle:hover {
      background: #e67e22;
      transform: translateY(-1px);
    }

    .code-toggle.active {
      background: var(--primary);
    }

    .emoji-toggle {
      background: var(--secondary);
      border: none;
      color: white;
      padding: 0.5rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
    }

    .emoji-toggle:hover {
      background: #e67e22;
      transform: translateY(-1px);
    }

    .emoji-toggle.active {
      background: var(--primary);
    }

    .fullscreen-toggle {
      background: var(--secondary);
      border: none;
      color: white;
      padding: 0.5rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
    }

    .fullscreen-toggle:hover {
      background: #e67e22;
      transform: translateY(-1px);
    }

    .fullscreen-toggle.active {
      background: var(--primary);
    }

    .language-select {
      background: var(--dark);
      border: 1px solid var(--card-border);
      border-radius: 6px;
      padding: 0.25rem 0.5rem;
      color: var(--light);
      font-size: 0.75rem;
      cursor: pointer;
    }

    .language-select:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* Fullscreen Code Editor */
    .fullscreen-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 10000;
      display: none;
      backdrop-filter: blur(5px);
    }

    .fullscreen-editor {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      padding: 2rem;
      box-sizing: border-box;
    }

    .fullscreen-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--card-border);
    }

    .fullscreen-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--light);
    }

    .fullscreen-controls {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .fullscreen-textarea {
      flex: 1;
      background: var(--dark);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      padding: 1.5rem;
      color: var(--light);
      font-family: 'Courier New', monospace;
      font-size: 1rem;
      line-height: 1.6;
      resize: none;
      outline: none;
      margin-bottom: 1rem;
    }

    .fullscreen-textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .fullscreen-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }

    /* Emoji Picker */
    .emoji-picker {
      position: fixed;
      bottom: 100px;
      left: 1rem;
      right: 1rem;
      background: var(--dark);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(15px);
      z-index: 10000;
      max-height: 400px;
      overflow: hidden;
      animation: emojiSlideDown 0.3s ease-out;
    }

    @keyframes emojiSlideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .emoji-picker-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem;
      border-bottom: 1px solid var(--card-border);
      background: var(--card-bg);
    }

    .emoji-search {
      flex: 1;
    }

    .emoji-search input {
      width: 100%;
      background: var(--darker);
      border: 1px solid var(--card-border);
      border-radius: 6px;
      padding: 0.5rem 0.75rem;
      color: var(--light);
      font-size: 0.875rem;
    }

    .emoji-search input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .emoji-close {
      background: none;
      border: none;
      color: var(--gray);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .emoji-close:hover {
      color: var(--light);
      background: rgba(148, 163, 184, 0.1);
    }

    .emoji-categories {
      display: flex;
      gap: 0.25rem;
      padding: 0.5rem;
      border-bottom: 1px solid var(--card-border);
      background: var(--card-bg);
      overflow-x: auto;
    }

    .emoji-category {
      background: none;
      border: none;
      color: var(--gray);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 6px;
      transition: all 0.2s ease;
      font-size: 1.1rem;
      flex-shrink: 0;
    }

    .emoji-category:hover {
      background: rgba(148, 163, 184, 0.1);
      color: var(--light);
    }

    .emoji-category.active {
      background: var(--primary);
      color: white;
    }

    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 0.25rem;
      padding: 0.75rem;
      max-height: 280px;
      overflow-y: auto;
    }

    .emoji-item {
      background: none;
      border: none;
      color: var(--light);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 6px;
      transition: all 0.2s ease;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .emoji-item:hover {
      background: rgba(99, 102, 241, 0.2);
      transform: scale(1.1);
    }

    /* Code Editor */
    .code-block {
      background: var(--darker);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      margin: 0.5rem 0;
      overflow: hidden;
    }

    .code-header {
      background: rgba(30, 41, 59, 0.8);
      padding: 0.5rem 1rem;
      border-bottom: 1px solid var(--card-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.75rem;
      color: var(--gray);
    }

    .code-language {
      font-weight: 500;
      color: var(--secondary);
      text-transform: uppercase;
    }

    .code-copy {
      background: none;
      border: none;
      color: var(--gray);
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .code-copy:hover {
      color: var(--light);
      background: rgba(148, 163, 184, 0.1);
    }

    .code-content {
      padding: 1rem;
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
      line-height: 1.5;
      white-space: pre-wrap;
      overflow-x: auto;
      color: var(--light);
    }

    .members-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .member {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .member:hover {
      background: rgba(30, 41, 59, 0.5);
    }

    .member-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--primary-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      position: relative;
    }

    .member-info {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      flex: 1;
    }

    .member-name {
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .member-role {
      opacity: 0.8;
      font-size: 0.8rem;
    }

    .member-status {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--success);
      border: 2px solid var(--dark);
      position: absolute;
      bottom: -2px;
      right: -2px;
      box-shadow: 0 0 0 2px var(--success);
    }

    .online {
      background: var(--success);
      box-shadow: 0 0 0 2px var(--success);
    }

    .offline {
      background: var(--gray);
      box-shadow: 0 0 0 2px var(--gray);
    }

    /* ===== File preview modal ===== */
.preview-modal{
  position:fixed; inset:0; background:rgba(0,0,0,.85);
  z-index:11000; display:none; align-items:center; justify-content:center;
}
.preview-modal.open{display:flex;}
.preview-modal-content{
  background:var(--dark); border:1px solid var(--card-border);
  border-radius:12px; max-width:90vw; max-height:90vh; width:900px;
  padding:1rem; position:relative; overflow:auto;
}
.preview-modal-close{
  position:absolute; top:8px; right:8px;
  background:var(--danger); color:#fff; border:none; border-radius:50%;
  width:34px; height:34px; cursor:pointer;
}
.preview-modal iframe, .preview-modal img, .preview-modal pre{
  width:100%; max-height:80vh; border:none;
}
.preview-modal pre{color:var(--light); white-space:pre-wrap;}
/* ===== profile pop-over ===== */
.profile-pop {
  position: absolute;
  top: 60px; /* Adjust based on your header height */
  right: 20px; /* Position from right edge */
  background: var(--darker);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 1rem;
  min-width: 200px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  z-index: 1000;
  display: none;
  opacity: 0;
  transform: translateY(-10px);
  transition: all 0.3s ease;
}

.profile-pop.open {
  display: block;
  opacity: 1;
  transform: translateY(0);
}
.profile-pop::before{
  content:''; position:absolute; top:-6px; right:12px;
  border:6px solid transparent; border-bottom-color:var(--dark);
}
.pop-avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  margin-bottom: 0.5rem;
}
.pop-info h4 {
  margin: 0 0 0.5rem 0;
  color: var(--primary);
}
.pop-info p {
  margin: 0.25rem 0;
  color: var(--gray);
  font-size: 0.9rem;
}



    footer {
      text-align: center;
      padding: 1rem;
      background: var(--dark);
      font-size: 0.85rem;
      color: var(--gray);
      border-top: 1px solid var(--card-border);
      min-height: 50px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Toast Notification System */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      pointer-events: none;
    }

    .toast {
      background: var(--dark);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 1rem 1.25rem;
      color: var(--light);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      max-width: 300px;
      animation: toastSlideIn 0.3s ease-out;
      pointer-events: auto;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .toast.success {
      border-left: 4px solid var(--success);
    }

    .toast.error {
      border-left: 4px solid var(--danger);
    }

    .toast.info {
      border-left: 4px solid var(--primary);
    }

    .toast-icon {
      font-size: 1.1rem;
      flex-shrink: 0;
    }

    .toast.success .toast-icon {
      color: var(--success);
    }

    .toast.error .toast-icon {
      color: var(--danger);
    }

    .toast.info .toast-icon {
      color: var(--primary);
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
    }

    .toast-message {
      font-size: 0.8rem;
      color: var(--gray);
      line-height: 1.3;
    }

    .toast-close {
      background: none;
      border: none;
      color: var(--gray);
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 4px;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .toast-close:hover {
      color: var(--light);
      background: rgba(148, 163, 184, 0.1);
    }

    @keyframes toastSlideIn {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes toastSlideOut {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(100%);
      }
    }

    /* Confirmation Dialog */
    .confirm-dialog {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      z-index: 10000;
      display: none;
      justify-content: center;
      align-items: center;
      padding: 1rem;
    }

    .confirm-content {
      background: var(--dark);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      padding: 2rem;
      max-width: 400px;
      width: 100%;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .confirm-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--light);
      margin-bottom: 1rem;
    }

    .confirm-message {
      font-size: 0.9rem;
      color: var(--gray);
      margin-bottom: 2rem;
      line-height: 1.5;
    }

    .confirm-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
      .sidebar-grid {
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
      }
      
      .games-grid {
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
      }
    }

    @media (max-width: 768px) {
      header {
        padding: 0.75rem 1rem;
      }
      
      .user-info span {
        display: none;
      }
      
      .desktop-only {
        display: none;
      }
      
      .chat-container {
        height: 500px;
        min-height: 400px;
      }
      
      .message {
        max-width: 85%;
        font-size: 0.9rem;
      }
    }

    @media (max-width: 480px) {
      .emoji-picker {
        bottom: 80px;
        left: 0.5rem;
        right: 0.5rem;
        max-height: 300px;
      }

      .emoji-grid {
        grid-template-columns: repeat(6, 1fr);
        gap: 0.2rem;
        padding: 0.5rem;
        max-height: 220px;
      }

      .emoji-item {
        padding: 0.4rem;
        font-size: 1.1rem;
      }
    }

    /* Games Section Styles */
    .games-section {
  width: 100%;
}

.games-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1.5rem;
  margin-top: 1rem;
}

/* Responsive adjustments */
@media (max-width: 1400px) {
  .games-grid {
    grid-template-columns: repeat(4, 1fr);
  }
}

@media (max-width: 1100px) {
  .games-grid {
    grid-template-columns: repeat(3, 1fr);
  }
}

@media (max-width: 800px) {
  .games-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }
}

@media (max-width: 500px) {
  .games-grid {
    grid-template-columns: 1fr;
  }
}

.game-card {
  background: rgba(30, 41, 59, 0.3);
  border-radius: 12px;
  overflow: hidden;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 1px solid var(--card-border);
  position: relative;
  backdrop-filter: blur(10px);
  min-width: 0; /* Prevents overflow issues */
}

/* Rest of your CSS remains the same */
.game-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
  border-color: var(--primary);
}

.game-image {
  position: relative;
  height: 160px;
  overflow: hidden;
}

.game-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.3s ease;
}

.game-card:hover .game-image img {
  transform: scale(1.05);
}

.game-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: all 0.3s ease;
}

.game-card:hover .game-overlay {
  opacity: 1;
}

.game-overlay i {
  color: var(--primary);
  font-size: 2rem;
  transform: scale(0.8);
  transition: transform 0.3s ease;
}

.game-card:hover .game-overlay i {
  transform: scale(1);
}

.game-info {
  padding: 1.25rem;
}

.game-name {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--light);
  margin-bottom: 0.5rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.game-description {
  color: var(--gray);
  font-size: 0.875rem;
  line-height: 1.4;
  margin-bottom: 1rem;
}

.game-details {
  display: flex;
  justify-content: space-between;
  margin-bottom: 1rem;
  gap: 1rem;
}

.game-players,
.game-difficulty {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  font-size: 0.8rem;
  color: var(--gray);
}

.game-difficulty i {
  color: var(--secondary);
}

.game-players i {
  color: var(--primary);
}

.game-tags {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.tag {
  background: var(--primary);
  color: white;
  padding: 0.2rem 0.6rem;
  border-radius: 12px;
  font-size: 0.7rem;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.tag:nth-child(even) {
  background: var(--secondary);
}


    /* Sidebar Grid for 3 column layout */
    .sidebar-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 2rem;
      width: 100%;
    }

    /* Remove old sidebar styles */
    .sidebar {
      display: unset;
      max-width: unset;
      width: unset;
      flex-direction: unset;
      gap: unset;
      overflow-x: unset;
    }

    /* Game Modal Styles */
    .game-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 10000;
      display: none;
      backdrop-filter: blur(10px);
    }

    .game-modal-content {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .game-modal-header {
      background: var(--dark);
      padding: 1rem 2rem;
      border-bottom: 1px solid var(--card-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .game-modal-title {
      color: var(--light);
      font-size: 1.2rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .game-modal-close {
      background: var(--danger);
      border: none;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .game-modal-close:hover {
      background: #dc2626;
      transform: translateY(-1px);
    }

    .game-iframe {
      flex: 1;
      border: none;
      background: var(--darker);
    }
  </style>
  <style>
    body.modal-open {
      overflow: hidden !important;
      touch-action: none;
    }
  </style>
</head>
<body>

  <header>
    <div class="logo">
      <i class="fas fa-book-open"></i>
      <h1>Chill Space</h1>
    </div>
    <div class="header-actions">
      <div class="user-info">
        <div class="user-avatar" id="userAvatar">T</div>
        <span id="username">Username</span>
        
        <!-- Profile Popover should be OUTSIDE user-info, not inside userAvatar -->
        <div id="profilePopover" class="profile-pop">
          <img id="popImg" class="pop-avatar" src="Assets/default-avatar.png" alt="">
          <div class="pop-info">
            <h4 id="popName">Name</h4>
            <p id="popEmail">email@example.com</p>
            <p id="popDob">DOB: Not set</p>
          </div>
        </div>
      </div>
    </div>
    
      <button class="btn btn-danger btn-sm" id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i>
        <span class="desktop-only">Logout</span>
      </button>
    </div>
  </header>

  <main>
    <div class="main-content">
      <!-- Chat Container (Full Width) -->
      <section class="card chat-container">
        <div class="card-header">
          <h2><i class="fas fa-comments"></i> Group Chat AI-A4 </h2>
        </div>
        <div class="chat-messages" id="chatMessages">
          <!-- Messages will appear here -->
        </div>
        <div class="chat-input">
          <div class="chat-controls">
            <button class="code-toggle" id="codeToggle" title="Toggle Code Mode">
              <i class="fas fa-code"></i>
            </button>
            <button class="emoji-toggle" id="emojiToggle" title="Emoji Picker">
              <i class="fas fa-smile"></i>
            </button>
            <button class="fullscreen-toggle" id="fullscreenToggle" title="Fullscreen Code Editor" style="display: none;">
              <i class="fas fa-expand"></i>
            </button>
            <select class="language-select" id="languageSelect" style="display: none;">
              <option value="javascript">JavaScript</option>
              <option value="python">Python</option>
              <option value="html">HTML</option>
              <option value="css">CSS</option>
              <option value="java">Java</option>
              <option value="cpp">C++</option>
              <option value="csharp">C#</option>
              <option value="php">PHP</option>
              <option value="sql">SQL</option>
              <option value="bash">Bash</option>
              <option value="json">JSON</option>
              <option value="xml">XML</option>
              <option value="markdown">Markdown</option>
              <option value="plaintext">Plain Text</option>
            </select>
          </div>
          <input type="text" id="chatInput" placeholder="Type your message..." />
          <textarea id="codeInput" placeholder="Write your code here..." style="display: none;"></textarea>
          <button class="btn btn-primary" onclick="sendMessage()">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
        
        <!-- Emoji Picker -->
        <div class="emoji-picker" id="emojiPicker" style="display: none;">
          <div class="emoji-picker-header">
            <div class="emoji-search">
              <input type="text" id="emojiSearch" placeholder="Search emojis..." />
            </div>
            <button class="emoji-close" onclick="toggleEmojiPicker()">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="emoji-categories">
            <button class="emoji-category active" data-category="recent">üïí</button>
            <button class="emoji-category" data-category="smileys">üòä</button>
            <button class="emoji-category" data-category="animals">üê±</button>
            <button class="emoji-category" data-category="food">üçï</button>
            <button class="emoji-category" data-category="activities">‚öΩ</button>
            <button class="emoji-category" data-category="travel">‚úàÔ∏è</button>
            <button class="emoji-category" data-category="objects">üí°</button>
            <button class="emoji-category" data-category="symbols">üíï</button>
            <button class="emoji-category" data-category="flags">üèÅ</button>
          </div>
          <div class="emoji-grid" id="emojiGrid">
            <!-- Emojis will be loaded here -->
          </div>
        </div>
      </section>
  
      <!-- Three Column Layout for Upload, Files, Members -->
      <div class="sidebar-grid">
        <section class="card">
          <div class="card-header">
            <h2><i class="fas fa-cloud-upload-alt"></i> Upload Files</h2>
          </div>
          <div class="upload-area">
            <i class="fas fa-file-upload" style="font-size: 2rem; color: var(--primary);"></i>
            <h3>Drag & Drop files here</h3>
            <p>or click to browse</p>
            <input type="file" id="fileInput" multiple />
          </div>
          <div class="file-preview" id="filePreview">
            <h4><i class="fas fa-eye"></i> Selected Files</h4>
            <div class="no-files">No files selected</div>
          </div>
          <div style="margin-top: 1rem;">
            <button class="btn btn-primary" onclick="uploadFile()">
              <i class="fas fa-upload"></i> Upload
            </button>
          </div>
        </section>
  
        <section class="card">
          <div class="card-header">
            <h2><i class="fas fa-folder-open"></i> Shared Files</h2>
            <button class="btn btn-outline btn-sm" onclick="loadFiles()">
              <i class="fas fa-sync-alt"></i>
            </button>
          </div>
          <div class="file-list" id="fileContainer">
            <!-- Files will be loaded here -->
          </div>
        </section>
  
        <section class="card">
          <div class="card-header">
            <h2><i class="fas fa-users"></i> Online Members</h2>
            <span class="btn btn-outline btn-sm" id="onlineCount">0 Online</span>
          </div>
          <div class="members-list" id="membersList">
            <!-- Online members will appear here -->
          </div>
        </section>
      </div>
      
      <!-- Games Section (Full Width, now below sidebar-grid) -->
      <section class="card games-section">
        <div class="card-header">
          <h2><i class="fas fa-gamepad"></i> Feel bored? No worries...</h2>
          <span class="btn btn-outline btn-sm" id="gamesCount"></span>
        </div>
        <div class="games-grid">
          <!-- Game Card 1 -->
          <div class="game-card" onclick="openGame('chess')">
            <div class="game-image">
              <img src="Assets/chess2.jpg" alt="Chess Game" />
              <div class="game-overlay">
                <i class="fas fa-play"></i>
              </div>
            </div>
            <div class="game-info">
              <h3 class="game-name">Chess Master</h3>
              <p class="game-description">Classic chess game with multiplayer mode</p>
              <div class="game-details">
                <span class="game-players"><i class="fas fa-users"></i> 2 Players</span>
                <span class="game-difficulty"><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i> Hard </span>
              </div>
              <div class="game-tags">
                <span class="tag">Strategy</span>
                <span class="tag">Turn-based</span>
              </div>
            </div>
          </div>
  
          <!-- Game Card 2 -->
          <div class="game-card" onclick="openGame('tic-tac-toe')">
            <div class="game-image">
              <img src="Assets/Human Tic-Tac-Toe.jpg" alt="Tic Tac Toe" />
              <div class="game-overlay">
                <i class="fas fa-play"></i>
              </div>
            </div>
            <div class="game-info">
              <h3 class="game-name">Tic Tac Toe</h3>
              <p class="game-description">Quick and fun classic game for two players</p>
              <div class="game-details">
                <span class="game-players"><i class="fas fa-users"></i> 2 Players</span>
                <span class="game-difficulty"><i class="fas fa-star"></i><i class="fas fa-star"></i> Medium  </span>
              </div>
              <div class="game-tags">
                <span class="tag">Quick</span>
                <span class="tag">Classic</span>
              </div>
            </div>
          </div>
  
          <!-- Game Card 3 -->
          <div class="game-card" onclick="openGame('typemaster')">
            <div class="game-image">
              <img src="Assets/key.jpg" alt="Type Master" />
              <div class="game-overlay">
                <i class="fas fa-play"></i>
              </div>
            </div>
            <div class="game-info">
              <h3 class="game-name">Type Master</h3>
              <p class="game-description">Improve your typing speed in this fun and addictive word shooter.</p>
              <div class="game-details">
                <span class="game-players"><i class="fas fa-users"></i> 1 Player</span>
                <span class="game-difficulty"><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i> Hard </span>
              </div>
              <div class="game-tags">
                <span class="tag">Typing</span>
                <span class="tag">Skill</span>
              </div>
            </div>
          </div>
  
          <!-- Game Card 4 -->
          <div class="game-card" onclick="openGame('stone')">
            <div class="game-image">
              <img src="Assets/rps1.png" alt="stonepaperscissor" />
              <div class="game-overlay">
                <i class="fas fa-play"></i>
              </div>
            </div>
            <div class="game-info">
              <h3 class="game-name">Rock Paper Scissor (AI)</h3>
              <p class="game-description">Classic hand game with fast-paced decision making with AI.</p>
              <div class="game-details">
                <span class="game-players"><i class="fas fa-users"></i> 1 Player</span>
                <span class="game-difficulty"><i class="fas fa-star"></i> Easy </span>
              </div>
              <div class="game-tags">
                <span class="tag">Strategic</span>
                <span class="tag">Decision</span>
              </div>
            </div>
          </div>
  
          <!-- Game Card 5 -->
          <div class="game-card" onclick="openGame('advice')">
            <div class="game-image">
              <img src="Assets/advice.jpg" alt="Advice" />
              <div class="game-overlay">
                <i class="fas fa-play"></i>
              </div>
            </div>
            <div class="game-info">
              <h3 class="game-name">Free Advice</h3>
              <p class="game-description">Not a GAME ! Get a random life tip or motivational quote with a click.</p>
              <div class="game-details">
                <span class="game-players"><i class="fas fa-users"></i> 1 Player</span>
                <span class="game-difficulty"><i class="fas fa-star"></i> Easy</span>
              </div>
              <div class="game-tags">
                <span class="tag">Motivation</span>
                <span class="tag">Fun</span>
              </div>
            </div>
          </div>
  
          <!-- Game Card 6 -->
          <div class="game-card" onclick="openGame('whiteboard')">
            <div class="game-image">
              <img src="Assets/white.jpg" alt="whiteboard" />
              <div class="game-overlay">
                <i class="fas fa-play"></i>
              </div>
            </div>
            <div class="game-info">
              <h3 class="game-name">White Board</h3>
              <p class="game-description">Just a normal White Board !</p>
              <div class="game-details">
                <span class="game-players"><i class="fas fa-users"></i> 1 Player</span>
                <span class="game-difficulty"><i class="fas fa-star"></i> Easy</span>
              </div>
              <div class="game-tags">
                <span class="tag">Single</span>
                <span class="tag">Creative</span>
              </div>
            </div>
          </div>

          <!-- Game Card 7 -->
          <div class="game-card" onclick="openGame('dsasolver')">
            <div class="game-image">
              <img src="Assets/dsa.jpg" alt="DSA" />
              <div class="game-overlay">
                <i class="fas fa-play"></i>
              </div>
            </div>
            <div class="game-info">
              <h3 class="game-name">DSA Solver (ONLINE)</h3>
              <p class="game-description">Practice and solve Data Structures & Algorithms problems interactively online</p>
              <div class="game-details">
                <span class="game-players"><i class="fas fa-users"></i> 1 Player</span>
                <span class="game-difficulty" > ‚ò†Ô∏è‚ò†Ô∏è‚ò†Ô∏è Extreme  </span>
              </div>
              <div class="game-tags">
                <span class="tag">DSA</span>
                <span class="tag">Coding</span>
              </div>
            </div>
          </div>

          <!-- Game Card 8 -->
          <div class="game-card" onclick="openGame('quiz')">
            <div class="game-image">
              <img src="Assets/quiz.jpg" alt="quiz" />
              <div class="game-overlay">
                <i class="fas fa-play"></i>
              </div>
            </div>
            <div class="game-info">
              <h3 class="game-name">Take a QUIZ</h3>
              <p class="game-description">Challenge your knowledge with high-intensity quizzes across various topics</p>
              <div class="game-details">
                <span class="game-players"><i class="fas fa-users"></i> 1 Player</span>
                <span class="game-difficulty" ><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i> Hard  </span>
              </div>
              <div class="game-tags">
                <span class="tag">Quiz</span>
                <span class="tag">Trivia</span>
              </div>
            </div>
          </div>

          
          
        </div>
      </section>
    </div>
  </main>
  

  <!-- Fullscreen Code Editor -->
  <div class="fullscreen-overlay" id="fullscreenOverlay">
    <div class="fullscreen-editor">
      <div class="fullscreen-header">
        <div class="fullscreen-title">
          <i class="fas fa-code"></i> Code Editor
        </div>
        <div class="fullscreen-controls">
          <select class="language-select" id="fullscreenLanguageSelect">
            <option value="javascript">JavaScript</option>
            <option value="python">Python</option>
            <option value="html">HTML</option>
            <option value="css">CSS</option>
            <option value="java">Java</option>
            <option value="cpp">C++</option>
            <option value="csharp">C#</option>
            <option value="php">PHP</option>
            <option value="sql">SQL</option>
            <option value="bash">Bash</option>
            <option value="json">JSON</option>
            <option value="xml">XML</option>
            <option value="markdown">Markdown</option>
            <option value="plaintext">Plain Text</option>
          </select>
          <button class="btn btn-secondary" onclick="closeFullscreenEditor()">
            <i class="fas fa-times"></i> Close
          </button>
        </div>
      </div>
      <textarea class="fullscreen-textarea" id="fullscreenTextarea" placeholder="Write your code here..."></textarea>
      <div class="fullscreen-actions">
        <button class="btn btn-outline" onclick="clearFullscreenEditor()">
          <i class="fas fa-trash"></i> Clear
        </button>
        <button class="btn btn-primary" onclick="sendFullscreenCode()">
          <i class="fas fa-paper-plane"></i> Send Code
        </button>
      </div>
    </div>
  </div>

  <!-- Confirmation Dialog -->
  <div class="confirm-dialog" id="confirmDialog">
    <div class="confirm-content">
      <div class="confirm-title">Confirm Delete</div>
      <div class="confirm-message">Are you sure you want to delete this message? This action cannot be undone.</div>
      <div class="confirm-actions">
        <button class="btn btn-outline" onclick="hideConfirmDialog()">Cancel</button>
        <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>

  <!-- Toast Notification System -->
  <div id="toastContainer" class="toast-container"></div>

  <footer style="background: var(--dark); border-top: 1.5px solid var(--card-border); box-shadow: 0 -4px 24px -8px rgba(0,0,0,0.10), 0 -1px 0 0 rgba(148,163,184,0.10); padding: 2rem 0 1.2rem 0;">
    <div style="max-width: 800px; margin: 0 auto; display: flex; flex-direction: column; align-items: center; gap: 1.1em;">
      <div style="font-size: 1.15rem; font-weight: 600; color: var(--primary); display: flex; align-items: center; gap: 0.5em; letter-spacing: 0.01em;">
        <i class="fas fa-meteor"></i>
        Chill Space ‚Äì Tamizh & Co.
      </div>
      <div style="width: 100%; height: 1px; background: var(--card-border); margin: 0.5em 0 0.2em 0;"></div>
      <div style="display: flex; flex-direction: row; gap: 1.5em; flex-wrap: wrap; justify-content: center; align-items: center;">
        <a href="https://docs.google.com/forms/d/e/1FAIpQLSeZq1r-dkj_B6La2_owrnof10yGgF4AWWfqYHktguRD9Tfe7g/viewform?usp=dialog" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 0.4em; transition: color 0.2s;">
          <i class="fas fa-bug"></i>
          <span>Report a bug / Suggest a feature</span>
        </a>
        <span style="color: var(--gray); font-size: 1.1em;">|</span>
        <a href="mailto:jefftamizh01@gmail.com" style="color: var(--secondary); text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 0.4em; transition: color 0.2s;">
          <i class="fas fa-envelope"></i>
          <span>Contact: jefftamizh01@gmail.com</span>
        </a>
      </div>
      <div style="display: flex; flex-direction: row; gap: 1.2em; margin-top: 0.2em; justify-content: center; align-items: center;">
        <a href="https://github.com/Tamizh019" target="_blank" aria-label="GitHub" style="color: var(--gray); font-size: 1.35em; margin: 0 0.1em; transition: color 0.2s;"><i class="fab fa-github"></i></a>
        <a href="https://www.linkedin.com/in/tamizharasan-r-a6931828a/" target="_blank" aria-label="LinkedIn" style="color: #0A66C2; font-size: 1.35em; margin: 0 0.1em; transition: color 0.2s;"><i class="fab fa-linkedin"></i></a>
      </div>
      <div style="width: 100%; height: 1px; background: var(--card-border); margin: 0.7em 0 0.2em 0;"></div>
      <div style="font-size: 0.97rem; color: var(--gray); letter-spacing: 0.01em; display: flex; align-items: center; gap: 0.5em;">
        <span>For educational purposes only üíÄ</span>
      </div>
    </div>
  </footer>

  <script>
    // Initialize Supabase
    const supabaseUrl = 'https://cmriyjrqkvpdchvbpnne.supabase.co'
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtcml5anJxa3ZwZGNodmJwbm5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4MzcyODYsImV4cCI6MjA2ODQxMzI4Nn0.wWRO5jZuUfrMPV8A3J7j36yweLe4o-uIcSZYaMhY4O8'
    
    let supabaseClient;
    let currentUser = null;
    let currentProfile = null;
    let chatChannel = null;
    let presenceChannel = null;
    let onlineUsers = new Set();
    let isUserAdmin = false;
    let messageToDelete = null;
    
    // Initialize Supabase
    function initializeSupabase() {
      if (typeof supabase !== 'undefined') {
        supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);
        return true;
      }
      return false;
    }
    
    // Initialize app
    if (!initializeSupabase()) {
      const checkInterval = setInterval(() => {
        if (initializeSupabase()) {
          clearInterval(checkInterval);
          initializeApp();
        }
      }, 100);
    } else {
      initializeApp();
    }
    
    async function initializeApp() {
      try {
        // Get current user
        const { data: { user }, error } = await supabaseClient.auth.getUser();
        if (error || !user) {
          window.location.href = 'index.html';
          return;
        }
    
        currentUser = user;
        
        // Get user profile - FIX: Make sure to get all needed fields
        const { data: profile, error: profileError } = await supabaseClient
          .from('users')
          .select('username, role, email, dob, avatar_url')
          .eq('id', user.id)
          .single();
        
        if (profileError) {
          console.error('Profile fetch error:', profileError);
          // Fallback profile creation
          currentProfile = {
            username: user.user_metadata?.username || user.email?.split('@')[0] || 'User',
            role: 'user',
            email: user.email
          };
        } else {
          currentProfile = profile;
        }
        
        // Check admin status
        isUserAdmin = currentProfile?.role === 'admin';
        const isModerator = currentProfile?.role === 'moderator';
    
        // FIX: Update UI AFTER profile is loaded
        updateUserInfo();
        
        // FIX: Initialize profile popover after DOM is ready
        initializeProfilePopover();
        
        // Show welcome message
        showWelcomeToast();
    
        // Load initial data
        await loadMessages();
        await loadFiles();
        await loadOnlineMembers();
        updateGamesCount(); // FIX: Call this to update games count
    
        // Setup realtime
        setupRealtimeChat();
        setupPresenceTracking();
    
        // Setup event listeners
        setupEventListeners();
    
      } catch (error) {
        console.error('Error initializing app:', error);
        showToast('error', 'Initialization Error', 'Failed to load the application');
      }
    }
    
    // FIX: Improved user info update function
    function updateUserInfo() {
      const userAvatar = document.getElementById('userAvatar');
      const username = document.getElementById('username');
      
      if (!userAvatar || !username) {
        console.error('User info elements not found');
        return;
      }
      
      const displayName = getUserDisplayName(currentUser, currentProfile);
      userAvatar.textContent = displayName.charAt(0).toUpperCase();
      username.textContent = displayName;
      
      console.log('User info updated:', displayName); // Debug log
    }
    
    // FIX: Separate profile popover initialization
    function initializeProfilePopover() {
      const pop = document.getElementById('profilePopover');
      const userAvatar = document.getElementById('userAvatar');
      
      if (!pop || !userAvatar) {
        console.error('Profile popover elements not found');
        return;
      }
    
      function fillProfile() {
        if (!pop) return;
        
        const displayName = getUserDisplayName(currentUser, currentProfile);
        document.getElementById('popName').textContent = displayName;
        document.getElementById('popEmail').textContent = currentUser.email || '';
        document.getElementById('popDob').textContent = currentProfile?.dob ? `DOB: ${currentProfile.dob}` : '';
        
        const avatarUrl = currentProfile?.avatar_url || '';
        document.getElementById('popImg').src = avatarUrl || 'Assets/default-avatar.png';
      }
    
      function toggleProfile() {
        if (!pop) return;
        
        if (pop.classList.contains('open')) {
          pop.classList.remove('open');
        } else {
          fillProfile();
          const rect = userAvatar.getBoundingClientRect();
          pop.style.right = `${window.innerWidth - rect.right}px`;
          pop.style.top = `${rect.bottom + 8}px`;
          pop.classList.add('open');
        }
      }
    
      // Add click listener to user avatar
      userAvatar.addEventListener('click', toggleProfile);
    
      // Click outside to close
      document.addEventListener('click', (e) => {
        if (pop && !pop.contains(e.target) && e.target.id !== 'userAvatar') {
          pop.classList.remove('open');
        }
      });
    }
    
    function showWelcomeToast() {
      const displayName = getUserDisplayName(currentUser, currentProfile);
      showToast('success', `Welcome To Chill Space, ${displayName}!`, 'Ready to chill? üéâ', 4000);
    }
    
    // FIX: Improved getUserDisplayName function
    function getUserDisplayName(user, profile = null) {
      if (profile?.username) {
        return profile.username;
      }
      if (user?.user_metadata?.username) {
        return user.user_metadata.username;
      }
      if (user?.email) {
        return user.email.split('@')[0];
      }
      return 'User';
    }
    
    // FIX: Role-based message deletion function
    function canDeleteMessage(messageUserId, messageSenderRole) {
      const isCurrentUser = messageUserId === currentUser.id;
      const currentUserRole = currentProfile?.role || 'user';
      
      // Users can only delete their own messages
      if (currentUserRole === 'user') {
        return isCurrentUser;
      }
      
      // Admins can delete any message
      if (currentUserRole === 'admin') {
        return true;
      }
      
      // Moderators can delete any message except admin messages
      if (currentUserRole === 'moderator') {
        return messageSenderRole !== 'admin';
      }
      
      return false;
    }
    
    function setupEventListeners() {
      // Logout button
      document.getElementById('logoutBtn').addEventListener('click', logout);
    
      // Code toggle
      document.getElementById('codeToggle').addEventListener('click', toggleCodeMode);
    
      // Emoji toggle
      document.getElementById('emojiToggle').addEventListener('click', toggleEmojiPicker);
    
      // Fullscreen toggle
      document.getElementById('fullscreenToggle').addEventListener('click', openFullscreenEditor);
    
      // Chat input enter key
      document.getElementById('chatInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    
      // Code input enter key
      document.getElementById('codeInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && e.ctrlKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    
      // File input change
      document.getElementById('fileInput').addEventListener('change', updateFilePreview);
    
      // Emoji category buttons
      document.querySelectorAll('.emoji-category').forEach(button => {
        button.addEventListener('click', (e) => {
          document.querySelectorAll('.emoji-category').forEach(b => b.classList.remove('active'));
          e.target.classList.add('active');
          loadEmojis(e.target.dataset.category);
        });
      });
    
      // Emoji search
      document.getElementById('emojiSearch').addEventListener('input', (e) => {
        searchEmojis(e.target.value);
      });
    
      // Close emoji picker when clicking outside
      document.addEventListener('click', (e) => {
        const emojiPicker = document.getElementById('emojiPicker');
        const emojiToggle = document.getElementById('emojiToggle');
        
        if (!emojiPicker.contains(e.target) && !emojiToggle.contains(e.target)) {
          emojiPicker.style.display = 'none';
          emojiToggle.classList.remove('active');
        }
      });
    
      // Confirm dialog close on click outside
      document.getElementById('confirmDialog').addEventListener('click', (e) => {
        if (e.target === document.getElementById('confirmDialog')) {
          hideConfirmDialog();
        }
      });
    
      // Fullscreen editor close on escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          if (document.getElementById('fullscreenOverlay').style.display === 'flex') {
            closeFullscreenEditor();
          }
          if (document.getElementById('emojiPicker').style.display === 'block') {
            toggleEmojiPicker();
          }
        }
      });
    }
    
    /* === MODAL FUNCTIONS === */
    function openPreview(file) {
      const modal = document.getElementById('previewModal');
      const container = document.getElementById('previewBody');
      container.innerHTML = '';
      const { filetype, filepath, filename } = file;
    
      const { data } = supabaseClient.storage.from('files').getPublicUrl(filepath);
      const url = data.publicUrl;
    
      if (!url) { 
        showToast('error', 'Preview failed', 'No URL'); 
        return; 
      }
    
      if (filetype.startsWith('image/')) {
        const img = document.createElement('img');
        img.src = url; 
        container.appendChild(img);
      } else if (filetype === 'application/pdf') {
        const frame = document.createElement('iframe');
        frame.src = `${url}#toolbar=0&navpanes=0`;
        container.appendChild(frame);
      } else if (filetype.startsWith('text/')) {
        fetch(url)
          .then(r => r.text())
          .then(t => {
            const pre = document.createElement('pre');
            pre.textContent = t; 
            container.appendChild(pre);
          })
          .catch(() => showToast('error', 'Preview failed', 'Can\'t fetch text'));
      } else {
        container.innerHTML = `<p style="color:var(--gray);text-align:center">‚õî Preview not supported.<br>Download instead.</p>`;
      }
    
      modal.classList.add('open');
      document.body.classList.add('modal-open');
    }
    
    function closePreview() {
      document.getElementById('previewModal').classList.remove('open');
      document.body.classList.remove('modal-open');
    }
    
    async function logout() {
      try {
        const { error } = await supabaseClient.auth.signOut();
        if (!error) {
          showToast('success', 'Goodbye!', 'See you Soon! ‚òπÔ∏è');
          setTimeout(() => {
            window.location.href = "index.html";
          }, 1000);
        }
      } catch (err) {
        console.error('Error during logout:', err);
        showToast('error', 'Logout Error', 'Failed to logout');
      }
    }
    
    // Game Functions
    function openGame(gameType) {
      const gameUrls = {
        'chess': 'games/chess/chess.html',
        'tic-tac-toe': 'games/ttt/index.html',
        'typemaster': 'games/typemaster/index.html',
        'stone': 'games/stonepaper/index.html',
        'advice': 'games/advice/index.html',
        'whiteboard': 'games/white/index.html',
        'dsasolver': 'games/dsasolver/index.html',
        'quiz': 'games/Quiz/quiz.html',
      };
      
      const gameNames = {
        'chess': 'Chess Master',
        'tic-tac-toe': 'Tic Tac Toe',
        'typemaster': 'Type Master',
        'stone': 'Stone Paper Scissor',
        'advice': 'Free Advice',
        'whiteboard': 'White Board',
        'dsasolver': 'DSA Solver',
        'quiz': 'Take a QUIZ'
      };
      
      let gameModal = document.getElementById('gameModal');
      if (!gameModal) {
        gameModal = document.createElement('div');
        gameModal.id = 'gameModal';
        gameModal.className = 'game-modal';
        gameModal.innerHTML = `
          <div class="game-modal-content">
            <div class="game-modal-header">
              <div class="game-modal-title">
                <i class="fas fa-gamepad"></i>
                <span id="gameModalTitle">Game</span>
              </div>
              <button class="game-modal-close" onclick="closeGame()">
                <i class="fas fa-times"></i>
                Close Game
              </button>
            </div>
            <iframe id="gameIframe" class="game-iframe" src=""></iframe>
          </div>
        `;
        document.body.appendChild(gameModal);
      }
      
      document.getElementById('gameModalTitle').textContent = gameNames[gameType] || 'Game';
      var iframe = document.getElementById('gameIframe');
      iframe.src = gameUrls[gameType] || 'games/default.html';
      
      if (gameType === 'chess') {
        iframe.setAttribute('scrolling', 'no');
        iframe.style.overflow = 'hidden';
        iframe.style.background = 'var(--darker)';
      } else {
        iframe.removeAttribute('scrolling');
        iframe.style.overflow = '';
        iframe.style.background = '';
      }
      
      gameModal.style.display = 'flex';
      document.body.classList.add('modal-open');
      document.addEventListener('keydown', handleGameEscape);
      
      showToast('success', 'Game Loading', `Loading ${gameNames[gameType]}...`);
    }
    
    function closeGame() {
      const gameModal = document.getElementById('gameModal');
      if (gameModal) {
        gameModal.style.display = 'none';
        document.getElementById('gameIframe').src = '';
      }
      document.body.classList.remove('modal-open');
      document.removeEventListener('keydown', handleGameEscape);
    }
    
    function handleGameEscape(e) {
      if (e.key === 'Escape') {
        closeGame();
      }
    }
    
    // Setup online presence tracking
    function setupPresenceTracking() {
      presenceChannel = supabaseClient.channel('online-users', {
        config: {
          presence: {
            key: currentUser.id,
          },
        },
      });
    
      presenceChannel.on('presence', { event: 'sync' }, () => {
        const newState = presenceChannel.presenceState();
        onlineUsers.clear();
        
        Object.keys(newState).forEach(userId => {
          onlineUsers.add(userId);
        });
        
        updateOnlineMembers();
      });
    
      presenceChannel.on('presence', { event: 'join' }, ({ key, newPresences }) => {
        onlineUsers.add(key);
        updateOnlineMembers();
      });
    
      presenceChannel.on('presence', { event: 'leave' }, ({ key, leftPresences }) => {
        onlineUsers.delete(key);
        updateOnlineMembers();
      });
    
      presenceChannel.subscribe(async (status) => {
        if (status === 'SUBSCRIBED') {
          await presenceChannel.track({
            user_id: currentUser.id,
            username: getUserDisplayName(currentUser, currentProfile),
            role: currentProfile?.role || 'user',
            online_at: new Date().toISOString(),
          });
        }
      });
    }
    
    // Chat functionality
    async function sendMessage() {
      const chatInput = document.getElementById('chatInput');
      const codeInput = document.getElementById('codeInput');
      const codeToggle = document.getElementById('codeToggle');
      
      let messageText;
      if (codeToggle.classList.contains('active')) {
        messageText = codeInput.value.trim();
        if (messageText) {
          const languageSelect = document.getElementById('languageSelect');
          const language = languageSelect ? languageSelect.value : 'javascript';
          messageText = `\`\`\`${language}\n${messageText}\n\`\`\``;
        }
      } else {
        messageText = chatInput.value.trim();
      }
    
      if (!messageText) return;
    
      // Clear input immediately
      if (codeToggle.classList.contains('active')) {
        codeInput.value = '';
      } else {
        chatInput.value = '';
      }
    
      try {
        const { error } = await supabaseClient
          .from('messages')
          .insert({
            user_id: currentUser.id,
            content: messageText,
            sent_at: new Date().toISOString()
          });
    
        if (error) {
          throw error;
        }
    
      } catch (error) {
        console.error('Error sending message:', error);
        showToast('error', 'Send Failed', 'Could not send message');
        if (codeToggle.classList.contains('active')) {
          codeInput.value = messageText.replace(/``````$/g, '');
        } else {
          chatInput.value = messageText;
        }
      }
    }
    
    function showDeleteConfirmation(messageId) {
      messageToDelete = messageId;
      document.getElementById('confirmDialog').style.display = 'flex';
    }
    
    function hideConfirmDialog() {
      document.getElementById('confirmDialog').style.display = 'none';
      messageToDelete = null;
    }
    
    async function confirmDelete() {
      if (!messageToDelete) return;
    
      try {
        const { error } = await supabaseClient
          .from('messages')
          .delete()
          .eq('id', messageToDelete);
    
        if (error) {
          throw error;
        }
    
        showToast('success', 'Message Deleted', 'Message has been removed');
        
      } catch (error) {
        console.error('Error deleting message:', error);
        showToast('error', 'Delete Failed', 'Could not delete message');
      }
    
      hideConfirmDialog();
    }
    
    function deleteMessage(messageId) {
      showDeleteConfirmation(messageId);
    }
    
    // Toggle code mode
    function toggleCodeMode() {
      const chatInput = document.getElementById('chatInput');
      const codeInput = document.getElementById('codeInput');
      const codeToggle = document.getElementById('codeToggle');
      const languageSelect = document.getElementById('languageSelect');
      const fullscreenToggle = document.getElementById('fullscreenToggle');
      
      if (codeToggle.classList.contains('active')) {
        codeToggle.classList.remove('active');
        codeToggle.innerHTML = '<i class="fas fa-code"></i>';
        chatInput.style.display = 'block';
        codeInput.style.display = 'none';
        languageSelect.style.display = 'none';
        fullscreenToggle.style.display = 'none';
        chatInput.focus();
      } else {
        codeToggle.classList.add('active');
        codeToggle.innerHTML = '<i class="fas fa-comment"></i>';
        chatInput.style.display = 'none';
        codeInput.style.display = 'block';
        languageSelect.style.display = 'block';
        fullscreenToggle.style.display = 'block';
        codeInput.focus();
      }
    }
    
    // Fullscreen code editor functions
    function openFullscreenEditor() {
      const fullscreenOverlay = document.getElementById('fullscreenOverlay');
      const fullscreenTextarea = document.getElementById('fullscreenTextarea');
      const codeInput = document.getElementById('codeInput');
      const languageSelect = document.getElementById('languageSelect');
      const fullscreenLanguageSelect = document.getElementById('fullscreenLanguageSelect');
      
      fullscreenTextarea.value = codeInput.value;
      fullscreenLanguageSelect.value = languageSelect.value;
      
      fullscreenOverlay.style.display = 'flex';
      fullscreenTextarea.focus();
    }
    
    function closeFullscreenEditor() {
      const fullscreenOverlay = document.getElementById('fullscreenOverlay');
      const fullscreenTextarea = document.getElementById('fullscreenTextarea');
      const codeInput = document.getElementById('codeInput');
      const languageSelect = document.getElementById('languageSelect');
      const fullscreenLanguageSelect = document.getElementById('fullscreenLanguageSelect');
      
      codeInput.value = fullscreenTextarea.value;
      languageSelect.value = fullscreenLanguageSelect.value;
      
      fullscreenOverlay.style.display = 'none';
      codeInput.focus();
    }
    
    function clearFullscreenEditor() {
      document.getElementById('fullscreenTextarea').value = '';
    }
    
    async function sendFullscreenCode() {
      const fullscreenTextarea = document.getElementById('fullscreenTextarea');
      const fullscreenLanguageSelect = document.getElementById('fullscreenLanguageSelect');
      
      const code = fullscreenTextarea.value.trim();
      if (!code) return;
    
      const language = fullscreenLanguageSelect.value;
      const messageText = `\`\`\`${language}\n${code}\n\`\`\``;
    
      try {
        const { error } = await supabaseClient
          .from('messages')
          .insert({
            user_id: currentUser.id,
            content: messageText,
            sent_at: new Date().toISOString()
          });
    
        if (error) {
          throw error;
        }
    
        fullscreenTextarea.value = '';
        closeFullscreenEditor();
    
      } catch (error) {
        console.error('Error sending code:', error);
        showToast('error', 'Send Failed', 'Could not send code');
      }
    }
    
    // Emoji data and functions
    const emojiData = {
      recent: ['üòä', 'üëç', '‚ù§Ô∏è', 'üòÇ', 'üéâ', 'üî•', 'üíØ', 'üëè', 'üôè', '‚ú®'],
      smileys: ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÖ', 'üòÇ', 'ü§£', 'üòä', 'üòá', 'üôÇ', 'üôÉ', 'üòâ', 'üòå', 'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö', 'üòã', 'üòõ', 'üòù', 'üòú', 'ü§™', 'ü§®', 'üßê', 'ü§ì', 'üòé', 'ü§©', 'ü•≥', 'üòè', 'üòí', 'üòû', 'üòî', 'üòü', 'üòï', 'üôÅ', '‚òπÔ∏è', 'üò£', 'üòñ', 'üò´', 'üò©', 'ü•∫', 'üò¢', 'üò≠', 'üò§', 'üò†', 'üò°', 'ü§¨', 'ü§Ø', 'üò≥', 'ü•µ', 'ü•∂', 'üò±', 'üò®', 'üò∞', 'üò•', 'üòì', 'ü§ó', 'ü§î', 'ü§≠', 'ü§´', 'ü§•', 'üò∂', 'üòê', 'üòë', 'üòØ', 'üò¶', 'üòß', 'üòÆ', 'üò≤', 'ü•±', 'üò¥', 'ü§§', 'üò™', 'üòµ', 'ü§ê', 'ü•¥', 'ü§¢', 'ü§Æ', 'ü§ß', 'üò∑', 'ü§í', 'ü§ï', 'ü§ë', 'ü§†'],
      animals: ['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑', 'üê∏', 'üêµ', 'üêî', 'üêß', 'üê¶', 'üê§', 'üê£', 'ü¶Ü', 'ü¶Ö', 'ü¶â', 'ü¶á', 'üê∫', 'üêó', 'üê¥', 'ü¶Ñ', 'üêù', 'üêõ', 'ü¶ã', 'üêå', 'üêû', 'üêú'],
      food: ['üçé', 'üçê', 'üçä', 'üçã', 'üçå', 'üçâ', 'üçá', 'üçì', 'ü´ê', 'üçà', 'üçí', 'üçë', 'ü•≠', 'üçç', 'ü••', 'ü•ù', 'üçÖ', 'ü•ë', 'ü•¶', 'ü•¨', 'ü•í', 'üå∂Ô∏è', 'ü´ë', 'üåΩ', 'ü•ï'],
      activities: ['‚öΩ', 'üèÄ', 'üèà', '‚öæ', 'ü•é', 'üéæ', 'üèê', 'üèâ', 'ü•è', 'üé±', 'ü™Ä', 'üèì', 'üè∏', 'üèí', 'üèë', 'ü•ç', 'üèè', 'ü•Ö', '‚õ≥', 'ü™Å', 'üèπ', 'üé£', 'ü§ø', 'ü•ä', 'ü•ã'],
      travel: ['‚úàÔ∏è', 'üõ©Ô∏è', 'üõ´', 'üõ¨', 'ü™Ç', 'üí∫', 'üöÅ', 'üöü', 'üö†', 'üö°', 'üõ∞Ô∏è', 'üöÄ', 'üõ∏', 'üõéÔ∏è', 'üß≥', '‚åõ', '‚è∞', '‚è±Ô∏è', '‚è≤Ô∏è', 'üï∞Ô∏è', 'üåç', 'üåé', 'üåè'],
      objects: ['üí°', 'üî¶', 'üïØÔ∏è', 'ü™î', 'üßØ', 'üõ¢Ô∏è', 'üí∏', 'üíµ', 'üí¥', 'üí∂', 'üí∑', 'ü™ô', 'üí∞', 'üí≥', 'üíé', '‚öñÔ∏è', 'ü™ú', 'üß∞', 'ü™õ', 'üîß', 'üî®', '‚öíÔ∏è', 'üõ†Ô∏è'],
      symbols: ['‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üíü', '‚òÆÔ∏è', '‚úùÔ∏è', '‚ò™Ô∏è', 'üïâÔ∏è'],
      flags: ['üèÅ', 'üö©', 'üéå', 'üè¥', 'üè≥Ô∏è', 'üè≥Ô∏è‚Äçüåà', 'üè¥‚Äç‚ò†Ô∏è', 'üá¶üá®', 'üá¶üá©', 'üá¶üá´', 'üá¶üá¨', 'üá¶üá∑', 'üá¶üá≤', 'üá¶üáº', 'üá¶üá∫', 'üá¶üáπ', 'üá¶üáø']
    };
    
    // Toggle emoji picker
    function toggleEmojiPicker() {
      const emojiPicker = document.getElementById('emojiPicker');
      const emojiToggle = document.getElementById('emojiToggle');
      
      if (emojiPicker.style.display === 'none') {
        emojiPicker.style.display = 'block';
        emojiToggle.classList.add('active');
        loadEmojis('recent');
        document.getElementById('emojiSearch').focus();
      } else {
        emojiPicker.style.display = 'none';
        emojiToggle.classList.remove('active');
        document.getElementById('chatInput').focus();
      }
    }
    
    function loadEmojis(category) {
      const emojiGrid = document.getElementById('emojiGrid');
      const emojis = emojiData[category] || emojiData.recent;
      
      emojiGrid.innerHTML = '';
      emojis.forEach(emoji => {
        const button = document.createElement('button');
        button.className = 'emoji-item';
        button.textContent = emoji;
        button.onclick = () => insertEmoji(emoji);
        emojiGrid.appendChild(button);
      });
    }
    
    function insertEmoji(emoji) {
      const chatInput = document.getElementById('chatInput');
      const codeInput = document.getElementById('codeInput');
      const codeToggle = document.getElementById('codeToggle');
      
      if (codeToggle.classList.contains('active')) {
        const start = codeInput.selectionStart;
        const end = codeInput.selectionEnd;
        const text = codeInput.value;
        codeInput.value = text.substring(0, start) + emoji + text.substring(end);
        codeInput.setSelectionRange(start + emoji.length, start + emoji.length);
        codeInput.focus();
      } else {
        const start = chatInput.selectionStart;
        const end = chatInput.selectionEnd;
        const text = chatInput.value;
        chatInput.value = text.substring(0, start) + emoji + text.substring(end);
        chatInput.setSelectionRange(start + emoji.length, start + emoji.length);
        chatInput.focus();
      }
    }
    
    function searchEmojis(query) {
      if (!query) {
        loadEmojis('recent');
        return;
      }
    
      const emojiGrid = document.getElementById('emojiGrid');
      const allEmojis = Object.values(emojiData).flat();
      const filteredEmojis = allEmojis.slice(0, 64);
    
      emojiGrid.innerHTML = '';
      filteredEmojis.forEach(emoji => {
        const button = document.createElement('button');
        button.className = 'emoji-item';
        button.textContent = emoji;
        button.onclick = () => insertEmoji(emoji);
        emojiGrid.appendChild(button);
      });
    }
    
    // Real-time chat setup
    function setupRealtimeChat() {
      chatChannel = supabaseClient.channel('public:messages')
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'messages'
        }, async (payload) => {
          await handleNewMessage(payload.new);
        })
        .on('postgres_changes', {
          event: 'DELETE',
          schema: 'public',
          table: 'messages'
        }, (payload) => {
          handleDeletedMessage(payload.old.id);
        })
        .subscribe();
    }
    
    async function handleNewMessage(message) {
      const messagesContainer = document.getElementById('chatMessages');
      const isCurrentUser = message.user_id === currentUser.id;
      
      let senderName = 'Unknown';
      let senderRole = 'user';
      
      if (isCurrentUser) {
        senderName = getUserDisplayName(currentUser, currentProfile);
        senderRole = currentProfile?.role || 'user';
      } else {
        try {
          const { data: profile } = await supabaseClient
            .from('users')
            .select('username, email, role')
            .eq('id', message.user_id)
            .single();
          
          if (profile) {
            senderName = profile.username || profile.email.split('@')[0];
            senderRole = profile.role || 'user';
          }
        } catch (err) {
          console.log('Could not fetch sender info:', err);
        }
      }
    
      const messageElement = document.createElement('div');
      messageElement.className = isCurrentUser ? 'message message-sent fade-in' : 'message message-received fade-in';
      messageElement.setAttribute('data-message-id', message.id);
      
      const roleClass = `role-${senderRole}`;
      const roleDisplay = getRoleEmoji(senderRole);
      
      messageElement.innerHTML = `
        <div class="message-sender">
          ${senderName}
          <span class="user-role ${roleClass}">${roleDisplay} ${senderRole}</span>
        </div>
        <div class="message-content">
          ${formatMessage(message.content)}
          ${canDeleteMessage(message.user_id, senderRole) ? `<button class="message-delete" onclick="deleteMessage('${message.id}')" title="Delete message">
            <i class="fas fa-times"></i>
          </button>` : ''}
        </div>
        <div class="message-time">${formatTime(new Date(message.sent_at))}</div>
      `;
      
      messagesContainer.appendChild(messageElement);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    function handleDeletedMessage(messageId) {
      const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
      if (messageElement) {
        messageElement.style.opacity = '0';
        messageElement.style.transform = 'translateX(20px)';
        setTimeout(() => {
          messageElement.remove();
        }, 300);
      }
    }
    
    function getRoleEmoji(role) {
      const roleEmojis = {
        admin: 'üëë',
        moderator: 'üõ°Ô∏è',
        vip: '‚≠ê',
        user: 'üë§'
      };
      return roleEmojis[role] || 'üë§';
    }
    
    // Load initial messages
    async function loadMessages() {
      try {
        const { data: messages, error } = await supabaseClient
          .from('messages')
          .select('*')
          .order('sent_at', { ascending: true })
          .limit(50);
    
        if (error) {
          console.error('Error loading messages:', error);
          return;
        }
    
        const messagesContainer = document.getElementById('chatMessages');
        messagesContainer.innerHTML = '';
    
        if (!messages || messages.length === 0) {
          messagesContainer.innerHTML = '<p style="color: var(--gray); text-align: center; padding: 2rem;">No messages yet. Be the first to say hello! üëã</p>';
          return;
        }
    
        const userIds = [...new Set(messages.map(msg => msg.user_id))];
        
        let userProfiles = {};
        if (userIds.length > 0) {
          const { data: profiles } = await supabaseClient
            .from('users')
            .select('id, username, email, role')
            .in('id', userIds);
          
          if (profiles) {
            profiles.forEach(profile => {
              userProfiles[profile.id] = profile;
            });
          }
        }
    
        messages.forEach(msg => {
          const isCurrentUser = msg.user_id === currentUser.id;
          const messageElement = document.createElement('div');
          
          messageElement.className = isCurrentUser ? 'message message-sent fade-in' : 'message message-received fade-in';
          messageElement.setAttribute('data-message-id', msg.id);
          
          let senderName = 'Unknown';
          let senderRole = 'user';
          if (isCurrentUser) {
            senderName = getUserDisplayName(currentUser, currentProfile);
            senderRole = currentProfile?.role || 'user';
          } else {
            const profile = userProfiles[msg.user_id];
            if (profile) {
              senderName = profile.username || profile.email.split('@')[0];
              senderRole = profile.role || 'user';
            }
          }
    
          const roleClass = `role-${senderRole}`;
          const roleDisplay = getRoleEmoji(senderRole);
          
          messageElement.innerHTML = `
            <div class="message-sender">
              ${senderName}
              <span class="user-role ${roleClass}">${roleDisplay} ${senderRole}</span>
            </div>
            <div class="message-content">
              ${formatMessage(msg.content)}
              ${canDeleteMessage(msg.user_id, senderRole) ? `<button class="message-delete" onclick="deleteMessage('${msg.id}')" title="Delete message">
                <i class="fas fa-times"></i>
              </button>` : ''}
            </div>
            <div class="message-time">${formatTime(new Date(msg.sent_at))}</div>
          `;
          
          messagesContainer.appendChild(messageElement);
        });
    
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      } catch (err) {
        console.error('Error in loadMessages:', err);
      }
    }
    
    // File upload functionality
    function updateFilePreview() {
      const fileInput = document.getElementById('fileInput');
      const filePreview = document.getElementById('filePreview');
      const files = fileInput.files;
      
      if (files.length === 0) {
        filePreview.innerHTML = '<h4><i class="fas fa-eye"></i> Selected Files</h4><div class="no-files">No files selected</div>';
        return;
      }
    
      let previewHTML = '<h4><i class="fas fa-eye"></i> Selected Files</h4>';
      
      Array.from(files).forEach((file, index) => {
        const isImage = file.type.startsWith('image/');
        const fileIcon = getFileIcon(file.type);
        
        previewHTML += `
          <div class="preview-item">
            <div class="preview-icon">
              ${isImage ? `<img src="${URL.createObjectURL(file)}" alt="${file.name}" class="preview-image">` : `<i class="fas ${fileIcon}"></i>`}
            </div>
            <div class="preview-info">
              <div class="preview-name">${file.name}</div>
              <div class="preview-size">${formatFileSize(file.size)}</div>
            </div>
            <button class="preview-remove" onclick="removeFileFromPreview(${index})">
              <i class="fas fa-times"></i>
            </button>
          </div>
        `;
      });
      
      filePreview.innerHTML = previewHTML;
    }
    
    function removeFileFromPreview(index) {
      const fileInput = document.getElementById('fileInput');
      const dt = new DataTransfer();
      const files = fileInput.files;
      
      Array.from(files).forEach((file, i) => {
        if (i !== index) {
          dt.items.add(file);
        }
      });
      
      fileInput.files = dt.files;
      updateFilePreview();
    }
    
    async function uploadFile() {
      const fileInput = document.getElementById('fileInput');
      const files = fileInput.files;
      
      if (!files || files.length === 0) {
        showToast('error', 'No Files Selected', 'Please select files to upload.');
        return;
      }
    
      showToast('info', 'Uploading Files', `Uploading ${files.length} file(s)...`);
    
      let uploadedCount = 0;
      for (const file of files) {
        try {
          const fileExt = file.name.split('.').pop();
          const fileName = `${currentUser.id}/${Date.now()}_${Math.random().toString(36).substring(2)}.${fileExt}`;
    
          const { error: uploadError } = await supabaseClient.storage
            .from('files')
            .upload(fileName, file);
    
          if (uploadError) throw uploadError;
    
          const { error: dbError } = await supabaseClient
            .from('files')
            .insert({
              user_id: currentUser.id,
              filename: file.name,
              filetype: file.type,
              filepath: fileName,
              filesize: file.size
            });
    
          if (dbError) throw dbError;
          uploadedCount++;
    
        } catch (err) {
          console.error('Error uploading file:', err);
        }
      }
    
      if (uploadedCount > 0) {
        showToast('success', 'Upload Complete!', `Successfully uploaded ${uploadedCount} file(s)!`);
        fileInput.value = '';
        updateFilePreview();
        loadFiles();
      } else {
        showToast('error', 'Upload Failed', 'No files were uploaded successfully.');
      }
    }
    
    // Load files
    async function loadFiles() {
      try {
        const { data: files, error } = await supabaseClient
          .from('files')
          .select('*')
          .order('uploaded_at', { ascending: false });
    
        if (error) {
          console.error('Error loading files:', error);
          return;
        }
    
        const fileContainer = document.getElementById('fileContainer');
        fileContainer.innerHTML = '';
    
        if (!files || files.length === 0) {
          fileContainer.innerHTML = '<p style="color: var(--gray); text-align: center;">No files shared yet</p>';
          return;
        }
    
        files.forEach(file => {
          const fileItem = document.createElement('div');
          fileItem.onclick = () => openPreview(file); 
          fileItem.className = 'file-item fade-in';
          fileItem.innerHTML = `
            <div class="file-info">
              <i class="fas ${getFileIcon(file.filetype)} file-icon"></i>
              <div class="file-details">
                <div class="file-name" title="${file.filename}">${file.filename}</div>
                <div class="file-meta">${formatFileSize(file.filesize)}</div>
              </div>
            </div>
            <div class="file-actions">
              <button class="btn btn-outline btn-sm" onclick="downloadFile('${file.filepath}', '${file.filename}')">
                <i class="fas fa-download"></i>
              </button>
              <button class="btn btn-danger btn-sm" onclick="deleteFile('${file.id}', '${file.filepath}', '${file.filename}')">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          `;
          fileContainer.appendChild(fileItem);
        });
      } catch (err) {
        console.error('Error in loadFiles:', err);
      }
    }
    
    async function downloadFile(filepath, filename) {
      try {
        const { data, error } = await supabaseClient.storage
          .from('files')
          .download(filepath);
    
        if (error) throw error;
    
        const url = URL.createObjectURL(data);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast('success', 'Download Started', `${filename} download began!`);
      } catch (err) {
        console.error('Error downloading file:', err);
        showToast('error', 'Download Failed', 'Could not download file.');
      }
    }
    
    async function deleteFile(fileId, filepath, filename) {
      if (!confirm(`Delete "${filename}"?`)) return;
    
      try {
        await supabaseClient.storage
          .from('files')
          .remove([filepath]);
    
        await supabaseClient
          .from('files')
          .delete()
          .eq('id', fileId)
          .eq('user_id', currentUser.id);
    
        showToast('success', 'File Deleted', `"${filename}" deleted successfully!`);
        loadFiles();
      } catch (err) {
        console.error('Error deleting file:', err);
        showToast('error', 'Delete Failed', 'Could not delete file.');
      }
    }
    
    // Load online members
    async function loadOnlineMembers() {
      try {
        const { data: allMembers, error } = await supabaseClient
          .from('users')
          .select('id, username, email, role')
          .order('username', { ascending: true });
    
        if (error) {
          console.error('Error loading members:', error);
          return;
        }
    
        updateOnlineMembers(allMembers);
        
      } catch (err) {
        console.error('Error in loadOnlineMembers:', err);
      }
    }
    
    function updateOnlineMembers(allMembers = null) {
      const membersList = document.getElementById('membersList');
      const onlineCount = document.getElementById('onlineCount');
      
      if (!allMembers) {
        loadOnlineMembers();
        return;
      }
    
      const onlineMembers = allMembers.filter(member => onlineUsers.has(member.id));
      
      membersList.innerHTML = '';
      
      if (onlineMembers.length === 0) {
        membersList.innerHTML = '<p style="color: var(--gray); text-align: center;">No members online</p>';
        onlineCount.textContent = '0 Online';
        return;
      }
    
      onlineMembers.forEach(member => {
        const memberElement = document.createElement('div');
        memberElement.className = 'member';
        
        const displayName = member.username || member.email.split('@')[0];
        const avatarInitial = displayName.charAt(0).toUpperCase();
        const roleEmoji = getRoleEmoji(member.role || 'user');
        
        memberElement.innerHTML = `
          <div class="member-avatar">
            ${avatarInitial}
            <div class="member-status online"></div>
          </div>
          <div class="member-info">
            <div class="member-name">
              ${displayName}
              <span class="user-role role-${member.role || 'user'}">${roleEmoji} ${member.role || 'user'}</span>
            </div>
            <div class="member-role">Online now</div>
          </div>
        `;
        
        membersList.appendChild(memberElement);
      });
    
      onlineCount.textContent = `${onlineMembers.length} Online`;
    }
    
    // Helper functions
    function formatMessage(content) {
  if (content.includes('```')) {
    return content.replace(/```(\w*)\n([\s\S]*?)```/g, (match, language, code) => {
      return `
        <div class="code-block">
          <div class="code-header">
            <span class="code-language">${language || 'code'}</span>
            <button class="code-copy" onclick="copyCode(this)">
              <i class="fas fa-copy"></i>
            </button>
          </div>
          <pre class="code-content"><code>${code.trim()}</code></pre>
        </div>
      `;
    });
  }
  return content;
}

    
    function formatTime(date) {
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
    
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    function getFileIcon(filetype) {
      const typeMap = {
        'pdf': 'fa-file-pdf',
        'doc': 'fa-file-word',
        'docx': 'fa-file-word',
        'ppt': 'fa-file-powerpoint',
        'pptx': 'fa-file-powerpoint',
        'jpg': 'fa-file-image',
        'jpeg': 'fa-file-image',
        'png': 'fa-file-image',
        'gif': 'fa-file-image',
        'mp4': 'fa-file-video',
        'mp3': 'fa-file-audio',
        'zip': 'fa-file-archive'
      };
    
      if (!filetype) return 'fa-file';
      const ext = filetype.split('/').pop();
      return typeMap[ext] || 'fa-file';
    }
    
    function safeCopy(text, target, btn) {
      if (!text) {
        showToast('error', 'Copy Failed', 'Nothing to copy!');
        return;
      }
      navigator.clipboard.writeText(text).then(() => {
        if (btn) {
          const original = btn.innerHTML;
          btn.innerHTML = '<i class="fas fa-check"></i>';
          btn.style.color = 'var(--success)';
          setTimeout(() => {
            btn.innerHTML = original;
            btn.style.color = 'var(--gray)';
          }, 2000);
        }
        showToast('success', 'Code Copied', 'Code copied to clipboard!');
      }).catch(() => {
        showToast('error', 'Copy Failed', 'Could not copy code to clipboard');
      });
    }
    
    function copyCode(copyBtn) {
      const codeBlock = copyBtn.closest('.code-block');
      if (!codeBlock) {
        showToast('error', 'Copy Failed', 'Code block not found!');
        return;
      }
      const codeElement = codeBlock.querySelector('.code-content');
      if (!codeElement) {
        showToast('error', 'Copy Failed', 'No code found to copy!');
        return;
      }
      const text = codeElement.textContent;
      safeCopy(text, codeElement, copyBtn);
    }
    
    function copyFromElement(selector) {
      const el = document.querySelector(selector);
      if (!el) {
        alert('Error: Copy target element not found');
        return;
      }
      safeCopy(el.textContent, el);
    }
    
    // Toast notification system
    function showToast(type, title, message, duration = 4000) {
      const toastContainer = document.getElementById('toastContainer');
      
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.id = `toast-${Date.now()}`;
      
      const iconMap = {
        success: 'fas fa-check-circle',
        error: 'fas fa-exclamation-circle',
        info: 'fas fa-info-circle'
      };
      
      toast.innerHTML = `
        <div class="toast-icon">
          <i class="${iconMap[type]}"></i>
        </div>
        <div class="toast-content">
          <div class="toast-title">${title}</div>
          <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close" onclick="closeToast('${toast.id}')" style="position:absolute;top:8px;right:8px;background:none;border:none;color:inherit;font-size:1.1em;cursor:pointer;">
          <i class="fas fa-times"></i>
        </button>
      `;
      
      toastContainer.appendChild(toast);
      
      setTimeout(() => {
        if (toast.parentElement) {
          toast.style.animation = 'toastSlideOut 0.3s ease-out forwards';
          setTimeout(() => {
            if (toast.parentElement) {
              toast.remove();
            }
          }, 300);
        }
      }, duration);
      
      return toast.id;
    }
    
    function closeToast(toastId) {
      const toast = document.getElementById(toastId);
      if (toast) {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 300);
      }
    }
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (chatChannel) {
        chatChannel.unsubscribe();
      }
      if (presenceChannel) {
        presenceChannel.unsubscribe();
      }
    });
    
    // FIX: Games count update function
    function updateGamesCount() {
      const gamesGrid = document.querySelector('.games-grid');
      const count = gamesGrid ? gamesGrid.querySelectorAll('.game-card').length : 0;
      const gamesCount = document.getElementById('gamesCount');
      if (gamesCount) {
        gamesCount.textContent = count + ' Games Available';
      }
    }
    
    // Call on page load
    document.addEventListener('DOMContentLoaded', updateGamesCount);
    </script>
    
  <!-- File-preview modal -->
<div id="previewModal" class="preview-modal">
  <div class="preview-modal-content">
    <button class="preview-modal-close" onclick="closePreview()">
      <i class="fas fa-times"></i>
    </button>
    <!-- Dynamic container -->
    <div id="previewBody"></div>
  </div>
</div>

</body>
</html>
