<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chill Space</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --secondary: #f59e0b;
      --dark: #0f172a;
      --darker: #020617;
      --light: #f8fafc;
      --gray: #94a3b8;  
      --success: #10b981;
      --danger: #ef4444;
      --card-bg: rgba(15, 23, 42, 0.7);
      --card-border: rgba(148, 163, 184, 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }

    body {
      background: var(--darker);
      color: var(--light);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
      overflow-x: hidden; /* Prevent horizontal scroll */
      width: 100%;
      max-width: 100vw;
    }

    header {
      background: var(--dark);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--card-border);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      min-height: 60px;
      flex-shrink: 0;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    header h1 {
      font-size: 1.5rem;
      font-weight: 600;
      background: linear-gradient(to right, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: white;
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
      transition: all 0.3s ease;
    }

    .user-avatar:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    .btn {
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      min-height: 44px; /* Touch-friendly minimum size */
      touch-action: manipulation; /* Optimize for touch */
    }

    .btn-primary {
      background: var(--primary);
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--secondary);
    }

    .btn-secondary:hover {
      background: #e67e22;
      transform: translateY(-1px);
    }

    .btn-danger {
      background: var(--danger);
    }

    .btn-danger:hover {
      background: #dc2626;
      transform: translateY(-1px);
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--gray);
      color: var(--gray);
    }

    .btn-outline:hover {
      border-color: var(--light);
      color: var(--light);
    }

    .btn-sm {
      padding: 0.25rem 0.75rem;
      font-size: 0.875rem;
    }

    .desktop-only {
      display: inline;
    }

    main {
      flex: 1;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 2rem;
      max-width: 1600px;
      margin: 0 auto;
      width: 100%;
      overflow-x: hidden;
    }

    .main-content {
      display: grid;
      grid-template-columns: 2.5fr 1fr;
      gap: 2.5rem;
      width: 100%;
      max-width: 100%;
    }

    .admin-full-width {
      width: 100%;
      margin-top: 1rem;
    }
    .content-area {
      display: flex;
      flex-direction: column;
      gap: 2rem;
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
    }
    .chat-container {
      height: 900px; 
      min-height: 700px;
      min-width: 0;
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
    }
    .sidebar {
      max-width: 420px;
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 2rem;
      overflow-x: hidden;
    }
    .card {
      background: var(--card-bg);
      padding: 1.5rem;
      border-radius: 12px;
      border: 1px solid var(--card-border);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .card h2 {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--light);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .file-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .file-item {
      background: rgba(30, 41, 59, 0.5);
      padding: 0.8rem 1rem;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
      cursor: pointer;
      gap: 0.75rem;
      min-height: 60px;
      animation: fileSlideIn 0.4s ease-out;
    }

    .file-item:hover {
      background: rgba(30, 41, 59, 0.8);
      transform: translateX(2px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
      border: 1px solid rgba(99, 102, 241, 0.3);
    }

    @keyframes fileSlideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .file-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex: 1;
      min-width: 0; 
      overflow: hidden;
    }

    .file-icon {
      color: var(--secondary);
      flex-shrink: 0; 
    }

    .file-details {
      flex: 1;
      min-width: 0; 
      overflow: hidden;
    }

    .file-name {
      font-weight: 500;
      color: var(--light);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .file-meta {
      font-size: 0.75rem;
      color: var(--gray);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .file-actions {
      display: flex;
      gap: 0.5rem;
      flex-shrink: 0; 
    }

    .file-actions button {
      cursor: pointer;
      flex-shrink: 0;
    }

    .upload-area {
      position: relative;
      border: 2px dashed var(--gray);
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      transition: all 0.3s ease;
      margin-top: 1rem;
    }

    .upload-area:hover {
      border-color: var(--primary);
    }

    .upload-area input {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      opacity: 0;
      cursor: pointer;
    }

    .upload-area p {
      color: var(--gray);
      margin-top: 0.5rem;
      font-size: 0.875rem;
    }

    .file-preview {
      margin-top: 1rem;
      padding: 1rem;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 8px;
      border: 1px solid var(--card-border);
      max-height: 300px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .file-preview h4 {
      color: var(--light);
      margin-bottom: 0.75rem;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .preview-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem;
      background: rgba(15, 23, 42, 0.3);
      border-radius: 6px;
      margin-bottom: 0.5rem;
      word-break: break-word;
      overflow-wrap: break-word;
    }

    .preview-item:last-child {
      margin-bottom: 0;
    }

    .preview-icon {
      color: var(--secondary);
      font-size: 1.2rem;
    }

    .preview-info {
      flex: 1;
    }

    .preview-name {
      font-weight: 500;
      color: var(--light);
      font-size: 0.875rem;
      word-break: break-word;
      overflow-wrap: break-word;
      max-width: 200px;
    }

    .preview-size {
      font-size: 0.75rem;
      color: var(--gray);
    }

    .preview-image {
      max-width: 60px;
      max-height: 60px;
      border-radius: 4px;
      object-fit: cover;
    }

    .preview-remove {
      background: var(--danger);
      border: none;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      transition: all 0.2s ease;
    }

    .preview-remove:hover {
      background: #dc2626;
      transform: scale(1.1);
    }

    .no-files {
      color: var(--gray);
      font-style: italic;
      text-align: center;
      padding: 1rem;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: var(--dark);
      border-radius: 12px;
      border: 1px solid var(--card-border);
      max-width: 90vw;
      max-height: 90vh;
      width: 800px;
      overflow: hidden;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--card-border);
      background: var(--card-bg);
    }

    .modal-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--light);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--gray);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      color: var(--light);
      background: rgba(148, 163, 184, 0.1);
    }

    .modal-body {
      padding: 1.5rem;
      max-height: 70vh;
      overflow-y: auto;
    }

    .preview-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }

    .preview-image {
      max-width: 100%;
      max-height: 60vh;
      border-radius: 8px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .preview-pdf {
      width: 100%;
      height: 60vh;
      border: none;
      border-radius: 8px;
    }

    .preview-text {
      background: var(--darker);
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid var(--card-border);
      width: 100%;
      max-height: 60vh;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      line-height: 1.5;
      white-space: pre-wrap;
    }

    .preview-unsupported {
      text-align: center;
      padding: 2rem;
      color: var(--gray);
    }

    .preview-unsupported i {
      font-size: 3rem;
      margin-bottom: 1rem;
      color: var(--secondary);
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--card-border);
      background: var(--card-bg);
    }

    .chat-container {
      display: flex;
      flex-direction: column;
      height: 800px;
      min-height: 600px;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      background: rgba(2, 6, 23, 0.5);
      border-radius: 8px;
      margin-bottom: 1rem;
      -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
      scroll-behavior: smooth; /* Smooth scroll to bottom */
      scrollbar-width: thin; /* Firefox */
      scrollbar-color: var(--gray) transparent; /* Firefox */
      width: 100%;
      max-width: 100%;
    }

    /* Custom scrollbar for Webkit browsers */
    .chat-messages::-webkit-scrollbar {
      width: 8px;
    }

    .chat-messages::-webkit-scrollbar-track {
      background: transparent;
      border-radius: 4px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: var(--gray);
      border-radius: 4px;
      transition: background 0.3s ease;
    }

    .chat-messages::-webkit-scrollbar-thumb:hover {
      background: var(--light);
    }

    .message {
      max-width: 80%;
      padding: 0.75rem 1rem;
      border-radius: 16px;
      position: relative;
      animation: messageSlideIn 0.3s ease-out;
      word-wrap: break-word;
      overflow-wrap: break-word;
      word-break: break-word;
    }

    @keyframes messageSlideIn {
      from {
        opacity: 0;
        transform: translateY(10px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .message-sent {
      align-self: flex-end;
      background: var(--primary);
      border-bottom-right-radius: 4px;
    }

    .message-received {
      align-self: flex-start;
      background: var(--dark);
      border-bottom-left-radius: 4px;
    }

    .message-sent:hover .message-delete {
      opacity: 1;
      visibility: visible;
    }

    .message-delete {
      position: absolute;
      top: -8px;
      right: -8px;
      background: var(--danger);
      border: none;
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      z-index: 10;
    }

    .message-delete:hover {
      background: #dc2626;
      transform: scale(1.1);
    }

    .message-content {
      position: relative;
    }

    .message-sender {
      font-weight: 600;
      font-size: 0.75rem;
      margin-bottom: 0.25rem;
      color: var(--secondary);
    }

    .message-time {
      font-size: 0.65rem;
      color: var(--gray);
      text-align: right;
      margin-top: 0.25rem;
    }

    .chat-input {
      display: flex;
      gap: 0.5rem;
      position: relative;
      width: 100%;
      max-width: 100%;
    }

    .chat-input input {
      flex: 1;
      background: var(--dark);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 0.75rem 1rem;
      color: var(--light);
      min-height: 44px; /* Touch-friendly minimum size */
      font-size: 16px; /* Prevent zoom on iOS */
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }

    .chat-input input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .chat-input textarea {
      flex: 1;
      background: var(--dark);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 0.75rem 1rem;
      color: var(--light);
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
      line-height: 1.4;
      resize: vertical;
      min-height: 60px;
      max-height: 200px;
      font-size: 16px; /* Prevent zoom on iOS */
    }

    .chat-input textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    .chat-controls {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .code-toggle {
      background: var(--secondary);
      border: none;
      color: white;
      padding: 0.5rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
    }

    .code-toggle:hover {
      background: #e67e22;
      transform: translateY(-1px);
    }

    .code-toggle.active {
      background: var(--primary);
    }

    .emoji-toggle {
      background: var(--secondary);
      border: none;
      color: white;
      padding: 0.5rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
    }

    .emoji-toggle:hover {
      background: #e67e22;
      transform: translateY(-1px);
    }

    .emoji-toggle.active {
      background: var(--primary);
    }

    /* Emoji Picker */
    .emoji-picker {
      position: fixed;
      bottom: 80px;
      left: 1rem;
      right: 1rem;
      background: var(--dark);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(15px);
      z-index: 10000;
      max-height: 400px;
      overflow: hidden;
      animation: emojiSlideDown 0.3s ease-out;
    }

    @keyframes emojiSlideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .emoji-picker-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem;
      border-bottom: 1px solid var(--card-border);
      background: var(--card-bg);
    }

    .emoji-search {
      flex: 1;
    }

    .emoji-search input {
      width: 100%;
      background: var(--darker);
      border: 1px solid var(--card-border);
      border-radius: 6px;
      padding: 0.5rem 0.75rem;
      color: var(--light);
      font-size: 0.875rem;
    }

    .emoji-search input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .emoji-close {
      background: none;
      border: none;
      color: var(--gray);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .emoji-close:hover {
      color: var(--light);
      background: rgba(148, 163, 184, 0.1);
    }

    .emoji-categories {
      display: flex;
      gap: 0.25rem;
      padding: 0.5rem;
      border-bottom: 1px solid var(--card-border);
      background: var(--card-bg);
      overflow-x: auto;
    }

    .emoji-category {
      background: none;
      border: none;
      color: var(--gray);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 6px;
      transition: all 0.2s ease;
      font-size: 1.1rem;
      flex-shrink: 0;
    }

    .emoji-category:hover {
      background: rgba(148, 163, 184, 0.1);
      color: var(--light);
    }

    .emoji-category.active {
      background: var(--primary);
      color: white;
    }

    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 0.25rem;
      padding: 0.75rem;
      max-height: 280px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .emoji-item {
      background: none;
      border: none;
      color: var(--light);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 6px;
      transition: all 0.2s ease;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .emoji-item:hover {
      background: rgba(99, 102, 241, 0.2);
      transform: scale(1.1);
    }

    .language-select {
      background: var(--dark);
      border: 1px solid var(--card-border);
      border-radius: 6px;
      padding: 0.25rem 0.5rem;
      color: var(--light);
      font-size: 0.75rem;
      cursor: pointer;
    }

    .language-select:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* Full Screen Code Mode */
    .fullscreen-code {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: var(--darker);
      z-index: 2000;
      display: none;
      flex-direction: column;
      backdrop-filter: blur(10px);
    }

    .fullscreen-code.active {
      display: flex;
    }

    .fullscreen-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background: var(--dark);
      border-bottom: 1px solid var(--card-border);
      flex-shrink: 0;
    }

    .fullscreen-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--light);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .fullscreen-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .fullscreen-textarea {
      flex: 1;
      background: var(--darker);
      border: none;
      color: var(--light);
      font-family: 'Courier New', monospace;
      font-size: 1rem;
      line-height: 1.6;
      padding: 2rem;
      resize: none;
      outline: none;
      min-height: 0;
    }

    .fullscreen-textarea::placeholder {
      color: var(--gray);
    }

    .fullscreen-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background: var(--dark);
      border-top: 1px solid var(--card-border);
      flex-shrink: 0;
    }

    .fullscreen-info {
      color: var(--gray);
      font-size: 0.875rem;
    }

    .fullscreen-actions {
      display: flex;
      gap: 0.75rem;
    }

    .btn-fullscreen {
      background: var(--primary);
      border: none;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-fullscreen:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .btn-fullscreen-secondary {
      background: var(--secondary);
    }

    .btn-fullscreen-secondary:hover {
      background: #e67e22;
    }

    .btn-fullscreen-outline {
      background: transparent;
      border: 1px solid var(--gray);
      color: var(--gray);
    }

    .btn-fullscreen-outline:hover {
      border-color: var(--light);
      color: var(--light);
    }

    .members-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .member {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .member:hover {
      background: rgba(30, 41, 59, 0.5);
    }

    .member-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--primary-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .member-info {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      flex: 1;
    }

    .member-name {
      font-weight: 500;
    }

    .member-role {
      opacity: 0.8;
    }

    /* Admin Role Management Styles */
    .role-management-content {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    .roles-table-section,
    .user-roles-section {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .roles-table-section h3,
    .user-roles-section h3 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--light);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .table-container {
      background: rgba(30, 41, 59, 0.5);
      border-radius: 8px;
      border: 1px solid var(--card-border);
      overflow: hidden;
      width: 100%;
      max-width: 100%;
    }

    .admin-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
      max-width: 100%;
      overflow-x: auto;
    }

    .admin-table th {
      background: rgba(15, 23, 42, 0.8);
      color: var(--light);
      font-weight: 600;
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--card-border);
    }

    .admin-table td {
      padding: 0.75rem;
      border-bottom: 1px solid var(--card-border);
      color: var(--light);
    }

    .admin-table tr:hover {
      background: rgba(30, 41, 59, 0.3);
    }

    .admin-table tr:last-child td {
      border-bottom: none;
    }

    .role-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .admin-actions {
      display: flex;
      gap: 0.5rem;
    }

    .admin-actions button {
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      min-height: auto;
    }

    .color-preview {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 1px solid var(--card-border);
    }

    .emoji-preview {
      font-size: 1.2rem;
    }

    .member-status {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-left: auto;
    }

    .online {
      background: var(--success);
    }

    .offline {
      background: var(--gray);
    }



    footer {
      text-align: center;
      padding: 1rem;
      background: var(--dark);
      font-size: 0.85rem;
      color: var(--gray);
      border-top: 1px solid var(--card-border);
      min-height: 50px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
      animation: fadeIn 0.3s ease forwards;
    }

    .code-block {
      background: var(--darker);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      margin: 0.5rem 0;
      overflow: hidden;
    }

    .code-header {
      background: rgba(30, 41, 59, 0.8);
      padding: 0.5rem 1rem;
      border-bottom: 1px solid var(--card-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.75rem;
      color: var(--gray);
    }

    .code-language {
      font-weight: 500;
      color: var(--secondary);
      text-transform: uppercase;
    }

    .code-copy {
      background: none;
      border: none;
      color: var(--gray);
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .code-copy:hover {
      color: var(--light);
      background: rgba(148, 163, 184, 0.1);
    }

    .code-content {
      padding: 1rem;
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
      line-height: 1.5;
      white-space: pre-wrap;
      overflow-x: auto;
      color: var(--light);
    }

    .code-content::-webkit-scrollbar {
      height: 6px;
    }

    .code-content::-webkit-scrollbar-track {
      background: var(--darker);
    }

    .code-content::-webkit-scrollbar-thumb {
      background: var(--gray);
      border-radius: 3px;
    }

    .code-content::-webkit-scrollbar-thumb:hover {
      background: var(--light);
    }

    @media (max-width: 1600px) {
      .main-content {
        grid-template-columns: 2fr 1fr;
        gap: 1.5rem;
      }
      .chat-container {
        height: 700px;
        min-height: 500px;
      }
      .sidebar {
        max-width: 350px;
      }
    }
    
    @media (max-width: 1024px) {
      main {
        padding: 1rem;
        width: 100%;
        max-width: 100vw;
      }
      .main-content {
        grid-template-columns: 1fr;
        gap: 1.5rem;
        width: 100%;
        max-width: 100%;
      }
      .chat-container {
        height: 550px;
        min-height: 450px;
        width: 100%;
        max-width: 100%;
      }
      .sidebar {
        max-width: 100%;
        width: 100%;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem;
      }
      .card {
        margin-bottom: 0;
        width: 100%;
        max-width: 100%;
      }
    }

    @media (max-width: 768px) {
      main {
        padding: 0.75rem;
        gap: 1rem;
        width: 100%;
        max-width: 100vw;
      }
      
      header {
        padding: 0.75rem 1rem;
        min-height: 55px;
      }
      
      header h1 {
        font-size: 1.25rem;
      }
      
      .logo i {
        font-size: 1.1rem;
      }
      
      .user-info span {
        display: none;
      }
      
      .desktop-only {
        display: none;
      }
      
      .header-actions {
        gap: 0.75rem;
      }
      
      .btn {
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
        min-height: 40px;
      }
      
      footer {
        padding: 0.75rem;
        min-height: 45px;
        font-size: 0.8rem;
      }
      
      .btn {
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
      }
      
      .btn-sm {
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
      }
      
      .card {
        padding: 1rem;
        border-radius: 10px;
      }
      
      .card-header {
        margin-bottom: 0.75rem;
      }
      
      .card h2 {
        font-size: 1.1rem;
      }
      
      .chat-container {
        height: 500px;
        min-height: 400px;
      }
      
      .chat-messages {
        padding: 0.75rem;
        gap: 0.75rem;
      }
      
      .message {
        max-width: 85%;
        padding: 0.6rem 0.8rem;
        font-size: 0.9rem;
      }
      
      .chat-input {
        gap: 0.4rem;
      }
      
      .chat-input input,
      .chat-input textarea {
        padding: 0.6rem 0.8rem;
        font-size: 0.9rem;
      }
      
      .file-item {
        padding: 0.6rem 0.8rem;
        min-height: 50px;
      }
      
      .file-name {
        font-size: 0.85rem;
      }
      
      .file-meta {
        font-size: 0.7rem;
      }
      
      .upload-area {
        padding: 1.5rem;
      }
      
      .upload-area h3 {
        font-size: 1rem;
      }
      
      .upload-area p {
        font-size: 0.8rem;
      }
      
      /* Admin table mobile fixes */
      .admin-table {
        font-size: 0.75rem;
      }
      
      .admin-table th,
      .admin-table td {
        padding: 0.5rem 0.4rem;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }
      
      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      

      

    }

    @media (max-width: 480px) {
      main {
        padding: 0.5rem;
        gap: 0.75rem;
        width: 100%;
        max-width: 100vw;
      }
      
      header {
        padding: 0.5rem 0.75rem;
        min-height: 50px;
      }
      
      header h1 {
        font-size: 1.1rem;
      }
      
      .logo {
        gap: 0.5rem;
      }
      
      .header-actions {
        gap: 0.5rem;
      }
      
      .user-avatar {
        width: 28px;
        height: 28px;
        font-size: 0.8rem;
      }
      
      .btn {
        padding: 0.5rem 0.75rem;
        font-size: 0.85rem;
        min-height: 38px;
      }
      
      footer {
        padding: 0.5rem;
        min-height: 40px;
        font-size: 0.75rem;
      }
      
      .card {
        padding: 0.75rem;
        border-radius: 8px;
      }
      
      .card-header {
        margin-bottom: 0.5rem;
      }
      
      .card h2 {
        font-size: 1rem;
      }
      
      .chat-container {
        height: 450px;
        min-height: 350px;
      }
      
      .chat-messages {
        padding: 0.5rem;
        gap: 0.5rem;
      }
      
      .message {
        max-width: 90%;
        padding: 0.5rem 0.6rem;
        font-size: 0.85rem;
      }
      
      .message-sender {
        font-size: 0.7rem;
      }
      
      .message-time {
        font-size: 0.6rem;
      }
      
      .chat-input {
        gap: 0.3rem;
      }
      
      .chat-input input,
      .chat-input textarea {
        padding: 0.5rem 0.6rem;
        font-size: 0.85rem;
        min-height: 45px;
      }
      
      .chat-controls {
        gap: 0.3rem;
      }
      
      .code-toggle {
        padding: 0.4rem;
        font-size: 0.8rem;
      }
      
      .language-select {
        padding: 0.2rem 0.4rem;
        font-size: 0.7rem;
      }
      
      .file-item {
        padding: 0.5rem 0.6rem;
        min-height: 45px;
        gap: 0.5rem;
      }
      
      .file-info {
        gap: 0.5rem;
      }
      
      .file-icon {
        font-size: 0.9rem;
      }
      
      .file-name {
        font-size: 0.8rem;
      }
      
      .file-meta {
        font-size: 0.65rem;
      }
      
      .file-actions {
        gap: 0.3rem;
      }
      
      .file-actions button {
        padding: 0.3rem 0.5rem;
        font-size: 0.75rem;
      }
      
      .upload-area {
        padding: 1rem;
      }
      
      .upload-area i {
        font-size: 1.5rem;
      }
      
      .upload-area h3 {
        font-size: 0.9rem;
        margin: 0.5rem 0;
      }
      
      .upload-area p {
        font-size: 0.75rem;
        margin-top: 0.3rem;
      }
      
      /* Admin table mobile fixes for small screens */
      .admin-table {
        font-size: 0.7rem;
      }
      
      .admin-table th,
      .admin-table td {
        padding: 0.4rem 0.3rem;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }
      
      .admin-actions {
        flex-direction: column;
        gap: 0.2rem;
      }
      
      .admin-actions button {
        padding: 0.2rem 0.4rem;
        font-size: 0.65rem;
        min-height: 30px;
      }
      
      .preview-item {
        padding: 0.4rem;
        gap: 0.5rem;
      }
      
      .preview-name {
        font-size: 0.8rem;
      }
      
      .preview-size {
        font-size: 0.65rem;
      }
      
      .preview-image {
        max-width: 50px;
        max-height: 50px;
      }
      
      .preview-remove {
        width: 20px;
        height: 20px;
        font-size: 0.65rem;
      }
      
      .members-list {
        gap: 0.5rem;
      }
      
      .member {
        padding: 0.4rem;
        gap: 0.5rem;
      }
      
      .member-avatar {
        width: 30px;
        height: 30px;
        font-size: 0.8rem;
      }
      
      .member-name {
        font-size: 0.85rem;
      }
      
      .member-status {
        width: 8px;
        height: 8px;
      }
      

      

      
      /* Modal improvements for mobile */
      .modal-content {
        max-width: 95vw;
        max-height: 95vh;
        margin: 1rem;
      }
      
      .modal-header,
      .modal-body,
      .modal-actions {
        padding: 0.75rem;
      }
      
      .modal-title {
        font-size: 1rem;
      }
      
      .modal-close {
        font-size: 1.25rem;
      }
      
      .fullscreen-header,
      .fullscreen-footer {
        padding: 0.75rem 1rem;
      }
      
      .fullscreen-title {
        font-size: 1rem;
      }
      
      .fullscreen-textarea {
        padding: 1rem;
        font-size: 0.9rem;
      }
      
      .fullscreen-info {
        font-size: 0.8rem;
      }
      
      .btn-fullscreen {
        padding: 0.4rem 0.8rem;
        font-size: 0.85rem;
      }

      /* Emoji picker mobile improvements */
      .emoji-picker {
        max-height: 350px;
        bottom: 70px;
        left: 0.75rem;
        right: 0.75rem;
      }

      .emoji-grid {
        grid-template-columns: repeat(6, 1fr);
        gap: 0.2rem;
        padding: 0.5rem;
        max-height: 220px;
      }

      .emoji-item {
        padding: 0.4rem;
        font-size: 1.1rem;
      }

      .emoji-categories {
        gap: 0.2rem;
        padding: 0.4rem;
      }

      .emoji-category {
        padding: 0.4rem;
        font-size: 1rem;
      }

      .emoji-picker-header {
        padding: 0.5rem;
      }

      .emoji-search input {
        padding: 0.4rem 0.6rem;
        font-size: 0.8rem;
      }

      .emoji-picker {
        bottom: 60px;
        left: 0.5rem;
        right: 0.5rem;
        max-height: 300px;
      }
    }


    /* Toast Notification System */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      pointer-events: none;
    }

    .toast {
      background: var(--dark);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 1rem 1.25rem;
      color: var(--light);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      max-width: 300px;
      animation: toastSlideIn 0.3s ease-out;
      pointer-events: auto;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .toast.success {
      border-left: 4px solid var(--success);
    }

    .toast.error {
      border-left: 4px solid var(--danger);
    }

    .toast.info {
      border-left: 4px solid var(--primary);
    }

    .toast-icon {
      font-size: 1.1rem;
      flex-shrink: 0;
    }

    .toast.success .toast-icon {
      color: var(--success);
    }

    .toast.error .toast-icon {
      color: var(--danger);
    }

    .toast.info .toast-icon {
      color: var(--primary);
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
    }

    .toast-message {
      font-size: 0.8rem;
      color: var(--gray);
      line-height: 1.3;
    }

    .toast-close {
      background: none;
      border: none;
      color: var(--gray);
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 4px;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .toast-close:hover {
      color: var(--light);
      background: rgba(148, 163, 184, 0.1);
    }

    @keyframes toastSlideIn {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes toastSlideOut {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(100%);
      }
    }

    /* Upload Progress Bar */
    .upload-progress {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--dark);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(15px);
      z-index: 10001;
      min-width: 300px;
      text-align: center;
      animation: progressSlideIn 0.3s ease-out;
    }

    .upload-progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(148, 163, 184, 0.2);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 1rem;
    }

    .upload-progress-fill {
      height: 100%;
      background: linear-gradient(to right, var(--primary), var(--secondary));
      border-radius: 4px;
      width: 0%;
      transition: width 0.3s ease;
      position: relative;
    }

    .upload-progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      animation: progressShimmer 1.5s infinite;
    }

    @keyframes progressShimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .upload-progress-text {
      color: var(--light);
      font-weight: 500;
      font-size: 0.9rem;
    }

    @keyframes progressSlideIn {
      from {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
    }

    /* Mobile responsive for toasts and progress */
    @media (max-width: 768px) {
      .toast-container {
        top: 10px;
        right: 10px;
        left: 10px;
      }

      .toast {
        max-width: none;
        padding: 0.75rem 1rem;
      }

      .upload-progress {
        min-width: 280px;
        margin: 1rem;
        padding: 1.25rem;
      }
    }

    @media (max-width: 480px) {
      .toast-container {
        top: 5px;
        right: 5px;
        left: 5px;
      }

      .toast {
        padding: 0.6rem 0.8rem;
        font-size: 0.85rem;
      }

      .toast-title {
        font-size: 0.85rem;
      }

      .toast-message {
        font-size: 0.75rem;
      }

      .upload-progress {
        min-width: 260px;
        padding: 1rem;
      }

      .upload-progress-text {
        font-size: 0.85rem;
      }
    }
  </style>
</head>
<body>

  <header>
    <div class="logo">
      <i class="fas fa-book-open"></i>
      <h1>Chill Space</h1>
    </div>
    <div class="header-actions">
      <div class="user-info">
        <div class="user-avatar" id="userAvatar"></div>
        <span id="username"></span>
      </div>
      <button class="btn btn-danger btn-sm" id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i>
        <span class="desktop-only">Logout</span>
      </button>
    </div>
  </header>

  <!-- File Preview Modal -->
  <div class="modal-overlay" id="filePreviewModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">
          <i class="fas fa-file" id="modalFileIcon"></i>
          <span id="modalFileName"></span>
        </div>
        <button class="modal-close" onclick="closeFilePreview()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="preview-container" id="modalPreviewContent">
          <!-- Preview content will be loaded here -->
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-outline" onclick="closeFilePreview()">
          <i class="fas fa-times"></i> Close
        </button>
        <button class="btn btn-primary" id="modalDownloadBtn">
          <i class="fas fa-download"></i> Download
        </button>
      </div>
    </div>
  </div>

  <!-- Full Screen Code Editor -->
  <div class="fullscreen-code" id="fullscreenCode">
    <div class="fullscreen-header">
      <div class="fullscreen-title">
        <i class="fas fa-code"></i>
        <span>Code Editor</span>
        <select class="language-select" id="fullscreenLanguageSelect">
          <option value="javascript">JavaScript</option>
          <option value="python">Python</option>
          <option value="html">HTML</option>
          <option value="css">CSS</option>
          <option value="java">Java</option>
          <option value="cpp">C++</option>
          <option value="csharp">C#</option>
          <option value="php">PHP</option>
          <option value="sql">SQL</option>
          <option value="bash">Bash</option>
          <option value="json">JSON</option>
          <option value="xml">XML</option>
          <option value="markdown">Markdown</option>
          <option value="plaintext">Plain Text</option>
        </select>
      </div>
      <div class="fullscreen-controls">
        <button class="btn-fullscreen btn-fullscreen-outline" onclick="exitFullscreenCode()">
          <i class="fas fa-times"></i> Exit
        </button>
      </div>
    </div>
    <textarea 
      class="fullscreen-textarea" 
      id="fullscreenCodeInput" 
      placeholder="Write your code here... Press Ctrl+Enter to send, Ctrl+S to save draft"
    ></textarea>
    <div class="fullscreen-footer">
      <div class="fullscreen-info">
        <span id="fullscreenCharCount">0 characters</span> ‚Ä¢ 
        <span id="fullscreenLineCount">1 line</span> ‚Ä¢ 
        Press <kbd>Ctrl+Enter</kbd> to send
      </div>
      <div class="fullscreen-actions">
        <button class="btn-fullscreen btn-fullscreen-outline" onclick="clearFullscreenCode()">
          <i class="fas fa-eraser"></i> Clear
        </button>
        <button class="btn-fullscreen btn-fullscreen-secondary" onclick="sendFullscreenCode()">
          <i class="fas fa-paper-plane"></i> Send Code
        </button>
      </div>
    </div>
  </div>

  <main>
    <div class="main-content">
      <div class="content-area">
        <!-- Chat box is now the main content -->
        <section class="card chat-container">
          <div class="card-header">
            <h2><i class="fas fa-comments"></i> Group Chat AI - A4</h2>
          </div>
          <div class="chat-messages" id="chatMessages">
            <!-- Messages will appear here -->
          </div>
          <div class="chat-input">
            <div class="chat-controls">
              <button class="code-toggle" id="codeToggle" title="Toggle Code Mode">
                <i class="fas fa-code"></i>
              </button>
              <button class="code-toggle" id="fullscreenToggle" title="Full Screen Code Editor" style="display: none;">
                <i class="fas fa-expand"></i>
              </button>
              <button class="emoji-toggle" id="emojiToggle" title="Emoji Picker">
                <i class="fas fa-smile"></i>
              </button>
              <select class="language-select" id="languageSelect" style="display: none;">
                <option value="javascript">JavaScript</option>
                <option value="python">Python</option>
                <option value="html">HTML</option>
                <option value="css">CSS</option>
                <option value="java">Java</option>
                <option value="cpp">C++</option>
                <option value="csharp">C#</option>
                <option value="php">PHP</option>
                <option value="sql">SQL</option>
                <option value="bash">Bash</option>
                <option value="json">JSON</option>
                <option value="xml">XML</option>
                <option value="markdown">Markdown</option>
                <option value="plaintext">Plain Text</option>
              </select>
            </div>
            <input type="text" id="chatInput" placeholder="Type your message..." />
            <textarea id="codeInput" placeholder="Write your code here..." style="display: none;"></textarea>
            <button class="btn btn-primary" onclick="sendMessage()">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
          
          <!-- Emoji Picker -->
          <div class="emoji-picker" id="emojiPicker" style="display: none;">
            <div class="emoji-picker-header">
              <div class="emoji-search">
                <input type="text" id="emojiSearch" placeholder="Search emojis..." />
              </div>
              <button class="emoji-close" onclick="toggleEmojiPicker()">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="emoji-categories">
              <button class="emoji-category active" data-category="recent">üïí</button>
              <button class="emoji-category" data-category="smileys">üòä</button>
              <button class="emoji-category" data-category="animals">üê±</button>
              <button class="emoji-category" data-category="food">üçï</button>
              <button class="emoji-category" data-category="activities">‚öΩ</button>
              <button class="emoji-category" data-category="travel">‚úàÔ∏è</button>
              <button class="emoji-category" data-category="objects">üí°</button>
              <button class="emoji-category" data-category="symbols">üíï</button>
              <button class="emoji-category" data-category="flags">üèÅ</button>
            </div>
            <div class="emoji-grid" id="emojiGrid">
              <!-- Emojis will be loaded here -->
            </div>
          </div>
        </section>
      </div>

      <div class="sidebar">
        <!-- Upload and shared files go here -->
        <section class="card">
          <div class="card-header">
            <h2><i class="fas fa-cloud-upload-alt"></i> Upload Anything</h2>
          </div>
          <div class="upload-area">
            <i class="fas fa-file-upload" style="font-size: 2rem; color: var(--primary);"></i>
            <h3>Drag & Drop files here</h3>
            <p>or click to browse (PDF, DOCX, PPT, IMAGES)</p>
            <input type="file" id="fileInput" multiple />
          </div>
          <div class="file-preview" id="filePreview">
            <h4><i class="fas fa-eye"></i> Selected Files</h4>
            <div class="no-files">No files selected</div>
          </div>
          <div style="margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
            <button class="btn btn-primary" onclick="uploadFile()">
              <i class="fas fa-upload"></i> Upload
            </button>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <h2><i class="fas fa-folder-open"></i> Shared Files</h2>
            <div style="display: flex; gap: 0.5rem;">
              <button class="btn btn-outline btn-sm" onclick="loadFiles()">
                <i class="fas fa-sync-alt"></i>
              </button>
            </div>
          </div>
          <div class="file-list" id="fileContainer">
            <!-- Files will be loaded here -->
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <h2><i class="fas fa-users"></i> Group Members</h2>
            <span class="btn btn-outline btn-sm" id="onlineCount">0 Online</span>
          </div>
          <div class="members-list" id="membersList">
            <!-- Members will appear here -->
          </div>
        </section>
      </div>
    </div>

    <!-- Admin Role Management Section - Full Width Below Chat -->
    <section class="card admin-full-width" id="adminSection" style="display: none;">
      <div class="card-header">
        <h2><i class="fas fa-user-shield"></i> Role Management</h2>
        <button class="btn btn-outline btn-sm" onclick="loadRoleManagement()">
          <i class="fas fa-sync-alt"></i>
        </button>
      </div>
      <div class="role-management-content">
        <!-- Roles Table -->
        <div class="roles-table-section">
          <h3><i class="fas fa-list"></i> Available Roles</h3>
          <div class="table-container">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Role</th>
                  <th>Display Name</th>
                  <th>Color</th>
                  <th>Emoji</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="rolesTableBody">
                <!-- Roles will be loaded here -->
              </tbody>
            </table>
          </div>
          <button class="btn btn-primary btn-sm" onclick="showAddRoleModal()">
            <i class="fas fa-plus"></i> Add New Role
          </button>
        </div>

                  <!-- User Roles Table -->
          <div class="user-roles-section">
            <h3><i class="fas fa-users"></i> All Users</h3>
            <div class="table-container">
              <table class="admin-table">
                <thead>
                  <tr>
                    <th>User</th>
                    <th>Email</th>
                    <th>Current Role</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="userRolesTableBody">
                  <!-- All users will be loaded here -->
                </tbody>
              </table>
            </div>
          </div>
      </div>
    </section>
  </main>



  <!-- Toast Notification System -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- Upload Progress Bar -->
  <div id="uploadProgress" class="upload-progress" style="display: none;">
    <div class="upload-progress-bar">
      <div class="upload-progress-fill" id="uploadProgressFill"></div>
    </div>
    <div class="upload-progress-text" id="uploadProgressText">Uploading...</div>
  </div>

  <footer>
    &copy; <span id="currentYear"></span> Chill Space ‚Äì Tamizh & Co.
  </footer>

  <script>
    // Initialize Supabase
    const supabaseUrl = 'https://umcmifajtomyvwjzmvpm.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVtY21pZmFqdG9teXZ3anptdnBtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3MzQzNTMsImV4cCI6MjA2NzMxMDM1M30._SjFGJOINRe0LTljlcK1h392iu5B5VJaAqK6sD3HJYI';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);



    // Authentication functions
    async function logout() {
  try {
    const { error } = await supabaseClient.auth.signOut();
    if (!error) {
      console.log('Sign out successful, redirecting...');
      window.location.href = "index.html";
    } else {
      console.error('Logout error:', error);
    }
  } catch (err) {
    console.error('Error during logout:', err);
  }
}


    // File upload functionality
    async function uploadFile() {
      const fileInput = document.getElementById('fileInput');
      const files = fileInput.files;
      
      // Client-side validation
      if (!files || files.length === 0) {
        showToast('error', 'No Files Selected', 'Please select at least one file to upload.');
        return;
      }

      // Check file sizes (max 10MB per file)
      const maxSize = 10 * 1024 * 1024; // 10MB
      for (const file of files) {
        if (file.size > maxSize) {
          showToast('error', 'File Too Large', `${file.name} is too large. Maximum size is 10MB.`);
          return;
        }
      }

      // Get current user
      const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
      if (userError || !user) {
        showToast('error', 'Authentication Error', 'Please log in to upload files.');
        return;
      }

      // Show upload progress
      showUploadProgress();

      let uploadedCount = 0;
      let errorCount = 0;

      for (const file of files) {
        try {
          console.log('Uploading file:', file.name, 'Size:', file.size, 'Type:', file.type);
          
          // Create a unique filename with user ID prefix
          const fileExt = file.name.split('.').pop();
          const timestamp = Date.now();
          const randomId = Math.random().toString(36).substring(2);
          const fileName = `${user.id}/${timestamp}_${randomId}.${fileExt}`;

          console.log('Generated file path:', fileName);

          // Upload file to storage
          const { data: uploadData, error: uploadError } = await supabaseClient.storage
            .from('files')
            .upload(fileName, file, {
              cacheControl: '3600',
              upsert: false
            });

          if (uploadError) {
            console.error('Error uploading file to storage:', uploadError);
            errorCount++;
            continue;
          }

          console.log('File uploaded to storage successfully:', uploadData);

          // Insert file record to database
          const { data: dbData, error: dbError } = await supabaseClient
            .from('files')
            .insert({
              user_id: user.id,
              filename: file.name,
              filetype: file.type,
              filepath: fileName,
              filesize: file.size
            })
            .select();

          if (dbError) {
            console.error('Error saving file info to database:', dbError);
            errorCount++;
            continue;
          }

          console.log('File record saved to database:', dbData);
          uploadedCount++;

        } catch (err) {
          console.error('Error processing file:', err);
          errorCount++;
        }
      }

      // Show results
      if (uploadedCount > 0) {
        showToast('success', 'Upload Successful!', `Successfully uploaded ${uploadedCount} file(s)!`);
        if (errorCount > 0) {
          showToast('error', 'Partial Upload', `${errorCount} file(s) failed to upload.`);
        }
        // Clear file input and preview after successful upload
        fileInput.value = '';
        updateFilePreview();
      } else {
        showToast('error', 'Upload Failed', 'No files were uploaded successfully. Please try again.');
      }

      loadFiles();
    }

    // File preview functionality
    function updateFilePreview() {
      const fileInput = document.getElementById('fileInput');
      const previewContainer = document.getElementById('filePreview');
      const files = fileInput.files;

      // Clear previous preview content
      const previewContent = previewContainer.querySelector('h4').nextElementSibling;
      if (previewContent) {
        previewContent.remove();
      }

      if (!files || files.length === 0) {
        const noFiles = document.createElement('div');
        noFiles.className = 'no-files';
        noFiles.textContent = 'No files selected';
        previewContainer.appendChild(noFiles);
        return;
      }

      const previewList = document.createElement('div');
      previewList.className = 'preview-list';

      Array.from(files).forEach((file, index) => {
        const previewItem = document.createElement('div');
        previewItem.className = 'preview-item fade-in';

        const fileIcon = document.createElement('i');
        fileIcon.className = `fas ${getFileIcon(file.type)} preview-icon`;

        const previewInfo = document.createElement('div');
        previewInfo.className = 'preview-info';

        const fileName = document.createElement('div');
        fileName.className = 'preview-name';
        fileName.textContent = file.name;

        const fileSize = document.createElement('div');
        fileSize.className = 'preview-size';
        fileSize.textContent = formatFileSize(file.size);

        previewInfo.appendChild(fileName);
        previewInfo.appendChild(fileSize);

        const removeBtn = document.createElement('button');
        removeBtn.className = 'preview-remove';
        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
        removeBtn.onclick = () => removeFile(index);

        previewItem.appendChild(fileIcon);
        previewItem.appendChild(previewInfo);

        // Add image preview if it's an image file
        if (file.type.startsWith('image/')) {
          const img = document.createElement('img');
          img.className = 'preview-image';
          img.src = URL.createObjectURL(file);
          img.alt = file.name;
          previewItem.appendChild(img);
        }

        previewItem.appendChild(removeBtn);
        previewList.appendChild(previewItem);
      });

      previewContainer.appendChild(previewList);
    }

    function removeFile(index) {
      const fileInput = document.getElementById('fileInput');
      const files = Array.from(fileInput.files);
      
      // Create a new FileList-like object without the removed file
      const dt = new DataTransfer();
      files.forEach((file, i) => {
        if (i !== index) {
          dt.items.add(file);
        }
      });
      
      fileInput.files = dt.files;
      updateFilePreview();
    }

    // Load files from database
    async function loadFiles() {
      try {
        console.log('Loading files from database...');
        
        const { data: files, error } = await supabaseClient
          .from('files')
          .select('*')
          .order('uploaded_at', { ascending: false });

        if (error) {
          console.error('Error loading files:', error);
          const fileContainer = document.getElementById('fileContainer');
          fileContainer.innerHTML = '<p style="color: var(--danger); text-align: center;">Error loading files. Please try again.</p>';
          return;
        }

        console.log('Files loaded from database:', files);

        const fileContainer = document.getElementById('fileContainer');
        fileContainer.innerHTML = '';

        if (!files || files.length === 0) {
          fileContainer.innerHTML = '<p style="color: var(--gray); text-align: center;">No files shared yet</p>';
          return;
        }

        files.forEach(file => {
          const fileItem = document.createElement('div');
          fileItem.className = 'file-item fade-in';
          fileItem.innerHTML = `
            <div class="file-info" onclick="previewFile('${file.id}', '${file.filepath}', '${file.filename}', '${file.filetype}')">
              <i class="fas ${getFileIcon(file.filetype)} file-icon"></i>
              <div class="file-details">
                <div class="file-name" title="${file.filename}">${file.filename}</div>
                <div class="file-meta">${formatFileSize(file.filesize)}</div>
              </div>
            </div>
            <div class="file-actions">
              <button class="btn btn-outline btn-sm" onclick="downloadFile('${file.filepath}', '${file.filename}')">
                <i class="fas fa-download"></i>
              </button>
              <button class="btn btn-danger btn-sm" onclick="deleteFile('${file.id}', '${file.filepath}', '${file.filename}')">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          `;
          fileContainer.appendChild(fileItem);
        });
      } catch (err) {
        console.error('Error in loadFiles:', err);
        const fileContainer = document.getElementById('fileContainer');
        fileContainer.innerHTML = '<p style="color: var(--danger); text-align: center;">Error loading files. Please try again.</p>';
      }
    }

    // Download file
    async function downloadFile(filepath, filename) {
      try {
        showToast('info', 'Downloading...', `Preparing ${filename} for download...`);
        
        const { data, error } = await supabaseClient.storage
          .from('files')
          .download(filepath);

        if (error) {
          showToast('error', 'Download Failed', 'Error downloading file: ' + error.message);
          return;
        }

        const url = URL.createObjectURL(data);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast('success', 'Download Started', `${filename} download has begun!`);
      } catch (err) {
        console.error('Error in downloadFile:', err);
        showToast('error', 'Download Error', 'An error occurred while downloading the file.');
      }
    }

    // Delete file
    async function deleteFile(fileId, filepath, filename) {
      if (!confirm(`Are you sure you want to delete "${filename}"?`)) {
        return;
      }

      try {
        // Get current user
        const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
        if (userError || !user) {
          showToast('error', 'Authentication Error', 'Please log in to delete files.');
          return;
        }

        showToast('info', 'Deleting...', `Removing ${filename}...`);

        // Delete from storage
        const { error: storageError } = await supabaseClient.storage
          .from('files')
          .remove([filepath]);

        if (storageError) {
          console.error('Error deleting file from storage:', storageError);
          showToast('error', 'Delete Failed', 'Error deleting file from storage. Please try again.');
          return;
        }

        // Delete from database
        const { error: dbError } = await supabaseClient
          .from('files')
          .delete()
          .eq('id', fileId)
          .eq('user_id', user.id); // Ensure user can only delete their own files

        if (dbError) {
          console.error('Error deleting file from database:', dbError);
          showToast('error', 'Delete Failed', 'Error deleting file from database. Please try again.');
          return;
        }

        console.log('File deleted successfully:', filename);
        showToast('success', 'File Deleted', `"${filename}" has been deleted successfully!`);
        
        // Reload the file list
        loadFiles();
      } catch (err) {
        console.error('Error in deleteFile:', err);
        showToast('error', 'Delete Error', 'An error occurred while deleting the file. Please try again.');
      }
    }

    // Chat functionality
    async function sendMessage() {
      const chatInput = document.getElementById('chatInput');
      const codeInput = document.getElementById('codeInput');
      const codeToggle = document.getElementById('codeToggle');
      const languageSelect = document.getElementById('languageSelect');
      
      let message = '';
      let isCode = codeToggle.classList.contains('active');
      
      if (isCode) {
        message = codeInput.value.trim();
        const language = languageSelect.value;
        if (!message) return;
        
        // Format as code block
        message = `\`\`\`${language}\n${message}\n\`\`\``;
      } else {
        message = chatInput.value.trim();
        if (!message) return;
      }

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        
        // Insert message to database
        const { error } = await supabaseClient
          .from('messages')
          .insert({
            user_id: user.id,
            content: message
          });

        if (error) {
          console.error('Error sending message:', error);
          return;
        }

        // Clear inputs
        chatInput.value = '';
        codeInput.value = '';
      } catch (err) {
        console.error('Error in sendMessage:', err);
      }
    }

    // Toggle code mode
    function toggleCodeMode() {
      const chatInput = document.getElementById('chatInput');
      const codeInput = document.getElementById('codeInput');
      const codeToggle = document.getElementById('codeToggle');
      const fullscreenToggle = document.getElementById('fullscreenToggle');
      const languageSelect = document.getElementById('languageSelect');
      
      if (codeToggle.classList.contains('active')) {
        // Switch to normal mode
        codeToggle.classList.remove('active');
        codeToggle.innerHTML = '<i class="fas fa-code"></i>';
        fullscreenToggle.style.display = 'none';
        chatInput.style.display = 'block';
        codeInput.style.display = 'none';
        languageSelect.style.display = 'none';
        chatInput.focus();
      } else {
        // Switch to code mode
        codeToggle.classList.add('active');
        codeToggle.innerHTML = '<i class="fas fa-comment"></i>';
        fullscreenToggle.style.display = 'block';
        chatInput.style.display = 'none';
        codeInput.style.display = 'block';
        languageSelect.style.display = 'block';
        codeInput.focus();
      }
    }

    // Emoji data
    const emojiData = {
      recent: ['üòä', 'üëç', '‚ù§Ô∏è', 'üòÇ', 'üéâ', 'üî•', 'üíØ', 'üëè', 'üôè', '‚ú®'],
      smileys: ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÖ', 'üòÇ', 'ü§£', 'üòä', 'üòá', 'üôÇ', 'üôÉ', 'üòâ', 'üòå', 'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö', 'üòã', 'üòõ', 'üòù', 'üòú', 'ü§™', 'ü§®', 'üßê', 'ü§ì', 'üòé', 'ü§©', 'ü•≥', 'üòè', 'üòí', 'üòû', 'üòî', 'üòü', 'üòï', 'üôÅ', '‚òπÔ∏è', 'üò£', 'üòñ', 'üò´', 'üò©', 'ü•∫', 'üò¢', 'üò≠', 'üò§', 'üò†', 'üò°', 'ü§¨', 'ü§Ø', 'üò≥', 'ü•µ', 'ü•∂', 'üò±', 'üò®', 'üò∞', 'üò•', 'üòì', 'ü§ó', 'ü§î', 'ü§≠', 'ü§´', 'ü§•', 'üò∂', 'üòê', 'üòë', 'üòØ', 'üò¶', 'üòß', 'üòÆ', 'üò≤', 'ü•±', 'üò¥', 'ü§§', 'üò™', 'üòµ', 'ü§ê', 'ü•¥', 'ü§¢', 'ü§Æ', 'ü§ß', 'üò∑', 'ü§í', 'ü§ï', 'ü§ë', 'ü§†'],
      animals: ['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑', 'üê∏', 'üêµ', 'üêî', 'üêß', 'üê¶', 'üê§', 'üê£', 'ü¶Ü', 'ü¶Ö', 'ü¶â', 'ü¶á', 'üê∫', 'üêó', 'üê¥', 'ü¶Ñ', 'üêù', 'üêõ', 'ü¶ã', 'üêå', 'üêû', 'üêú', 'ü¶ü', 'ü¶ó', 'üï∑Ô∏è', 'üï∏Ô∏è', 'ü¶Ç', 'üê¢', 'üêç', 'ü¶é', 'ü¶ñ', 'ü¶ï', 'üêô', 'ü¶ë', 'ü¶ê', 'ü¶û', 'ü¶Ä', 'üê°', 'üê†', 'üêü', 'üê¨', 'üê≥', 'üêã', 'ü¶à', 'üêä', 'üêÖ', 'üêÜ', 'ü¶ì', 'ü¶ç', 'ü¶ß', 'üêò', 'ü¶õ', 'ü¶è', 'üê™', 'üê´', 'ü¶í', 'ü¶ò', 'üêÉ', 'üêÇ', 'üêÑ', 'üêé', 'üêñ', 'üêè', 'üêë', 'ü¶ô', 'üêê', 'ü¶å', 'üêï', 'üê©', 'ü¶Æ', 'üêï‚Äçü¶∫', 'üêà', 'üêà‚Äç‚¨õ', 'üêì', 'ü¶É', 'ü¶ö', 'ü¶ú', 'ü¶¢', 'ü¶©', 'üïäÔ∏è', 'üêá', 'ü¶ù', 'ü¶®', 'ü¶°', 'ü¶´', 'ü¶¶', 'ü¶•', 'üêÅ', 'üêÄ', 'üêøÔ∏è', 'ü¶î'],
      food: ['üçé', 'üçê', 'üçä', 'üçã', 'üçå', 'üçâ', 'üçá', 'üçì', 'ü´ê', 'üçà', 'üçí', 'üçë', 'ü•≠', 'üçç', 'ü••', 'ü•ù', 'üçÖ', 'ü•ë', 'ü•¶', 'ü•¨', 'ü•í', 'üå∂Ô∏è', 'ü´ë', 'üåΩ', 'ü•ï', 'ü´í', 'üßÑ', 'üßÖ', 'ü•î', 'üç†', 'ü•ê', 'ü•Ø', 'üçû', 'ü•ñ', 'ü•®', 'üßÄ', 'ü•ö', 'üç≥', 'üßà', 'ü•û', 'üßá', 'ü•ì', 'ü•©', 'üçó', 'üçñ', 'ü¶¥', 'üå≠', 'üçî', 'üçü', 'üçï', 'ü•™', 'ü•ô', 'üßÜ', 'üåÆ', 'üåØ', 'ü´î', 'ü•ó', 'ü•ò', 'ü´ï', 'ü•´', 'üçù', 'üçú', 'üç≤', 'üçõ', 'üç£', 'üç±', 'ü•ü', 'ü¶™', 'üç§', 'üçô', 'üçö', 'üçò', 'üç•', 'ü•†', 'ü•Æ', 'üç¢', 'üç°', 'üçß', 'üç®', 'üç¶', 'ü•ß', 'üßÅ', 'üç∞', 'üéÇ', 'üçÆ', 'üç≠', 'üç¨', 'üç´', 'üçø', 'üç™', 'üå∞', 'ü•ú', 'üçØ', 'ü•õ', 'üçº', 'ü´ñ', '‚òï', 'üçµ', 'üßÉ', 'ü•§', 'üßã', 'üç∂', 'üç∫', 'üç∑', 'ü•Ç', 'ü•É', 'üç∏', 'üçπ', 'üßâ', 'üçæ', 'ü•Ñ', 'üç¥', 'üçΩÔ∏è', 'ü•£', 'ü•°', 'ü•¢', 'üßÇ'],
      activities: ['‚öΩ', 'üèÄ', 'üèà', '‚öæ', 'ü•é', 'üéæ', 'üèê', 'üèâ', 'ü•è', 'üé±', 'ü™Ä', 'üèì', 'üè∏', 'üèí', 'üèë', 'ü•ç', 'üèè', 'ü•Ö', '‚õ≥', 'ü™Å', 'üèπ', 'üé£', 'ü§ø', 'ü•ä', 'ü•ã', 'üéΩ', 'üõπ', 'üõ∑', '‚õ∏Ô∏è', 'ü•å', 'üéø', '‚õ∑Ô∏è', 'üèÇ', 'ü™Ç', 'üèãÔ∏è‚Äç‚ôÄÔ∏è', 'üèãÔ∏è', 'üèãÔ∏è‚Äç‚ôÇÔ∏è', 'ü§º‚Äç‚ôÄÔ∏è', 'ü§º', 'ü§º‚Äç‚ôÇÔ∏è', 'ü§∏‚Äç‚ôÄÔ∏è', 'ü§∏', 'ü§∏‚Äç‚ôÇÔ∏è', '‚õπÔ∏è‚Äç‚ôÄÔ∏è', '‚õπÔ∏è', '‚õπÔ∏è‚Äç‚ôÇÔ∏è', 'ü§∫', 'ü§æ‚Äç‚ôÄÔ∏è', 'ü§æ', 'ü§æ‚Äç‚ôÇÔ∏è', 'üèä‚Äç‚ôÄÔ∏è', 'üèä', 'üèä‚Äç‚ôÇÔ∏è', 'üö£‚Äç‚ôÄÔ∏è', 'üö£', 'üö£‚Äç‚ôÇÔ∏è', 'üèÑ‚Äç‚ôÄÔ∏è', 'üèÑ', 'üèÑ‚Äç‚ôÇÔ∏è', 'üö¥‚Äç‚ôÄÔ∏è', 'üö¥', 'üö¥‚Äç‚ôÇÔ∏è', 'üöµ‚Äç‚ôÄÔ∏è', 'üöµ', 'üöµ‚Äç‚ôÇÔ∏è', 'ü§Ω‚Äç‚ôÄÔ∏è', 'ü§Ω', 'ü§Ω‚Äç‚ôÇÔ∏è', 'üèá', 'üßò‚Äç‚ôÄÔ∏è', 'üßò', 'üßò‚Äç‚ôÇÔ∏è', 'üèÜ', 'ü•á', 'ü•à', 'ü•â', 'üèÖ', 'üéñÔ∏è', 'üèµÔ∏è', 'üéóÔ∏è', 'üé´', 'üéüÔ∏è', 'üé™', 'ü§π‚Äç‚ôÄÔ∏è', 'ü§π', 'ü§π‚Äç‚ôÇÔ∏è', 'üé≠', 'ü©∞', 'üé®', 'üé¨', 'üé§', 'üéß', 'üéº', 'üéπ', 'ü•Å', 'ü™ò', 'üé∑', 'üé∫', 'üé∏', 'ü™ï', 'üéª', 'üé≤', '‚ôüÔ∏è', 'üéØ', 'üé≥', 'üéÆ', 'üé∞', 'üß©', 'üé®', 'üì±', 'üì≤', 'üíª', '‚å®Ô∏è', 'üñ•Ô∏è', 'üñ®Ô∏è', 'üñ±Ô∏è', 'üñ≤Ô∏è', 'üíΩ', 'üíæ', 'üíø', 'üìÄ', 'üßÆ', 'üé•', 'üì∫', 'üìª', 'üì∑', 'üì∏', 'üìπ', 'üìº', 'üîã', 'üîå', 'üí°', 'üî¶', 'üïØÔ∏è', 'ü™î', 'üßØ', 'üõ¢Ô∏è', 'üí∏', 'üíµ', 'üí¥', 'üí∂', 'üí∑', 'ü™ô', 'üí∞', 'üí≥', 'üíé', '‚öñÔ∏è', 'ü™ú', 'üß∞', 'ü™õ', 'üîß', 'üî®', '‚öíÔ∏è', 'üõ†Ô∏è', '‚õèÔ∏è', 'ü™ö', 'üî©', '‚öôÔ∏è', 'ü™§', 'üß±', '‚õìÔ∏è', 'ü™ù', 'üß≤', 'üî´', 'üí£', 'ü™É', 'üèπ', 'üõ°Ô∏è', 'ü™Ñ', 'üîÆ', 'üßø', 'ü™¨', 'üìø', 'üß∏', 'ü™Ü', 'ü™Ö', 'ü™©', 'ü™û', 'ü™ü', 'ü™†', 'ü™°', 'ü™¢', 'üß∂', 'ü™£', 'ü™§', 'ü™•', 'ü™¶', 'ü™ß', '‚ö∞Ô∏è', 'ü™®', 'ü™©', 'ü™™', 'ü™´', 'ü™¨', 'ü™≠', 'ü™Æ', 'ü™Ø', 'ü™∞', 'ü™±', 'ü™≤', 'ü™≥', 'ü™¥', 'ü™µ', 'ü™∂', 'ü™∑', 'ü™∏', 'ü™π', 'ü™∫', 'ü™ª', 'ü™º', 'ü™Ω', 'ü™æ', 'ü™ø', 'ü´Ä', 'ü´Å', 'üß†', 'ü´Ç', 'ü´É', 'ü´Ñ', 'ü´Ö', 'ü´Ü', 'ü´á', 'ü´à', 'ü´â', 'ü´ä', 'ü´ã', 'ü´å', 'ü´ç', 'ü´é', 'ü´è', 'ü´ê', 'ü´ë', 'ü´í', 'ü´ì', 'ü´î', 'ü´ï', 'ü´ñ'],
      travel: ['‚úàÔ∏è', 'üõ©Ô∏è', 'üõ´', 'üõ¨', 'ü™Ç', 'üí∫', 'üöÅ', 'üöü', 'üö†', 'üö°', 'üõ∞Ô∏è', 'üöÄ', 'üõ∏', 'üõéÔ∏è', 'üß≥', '‚åõ', '‚è∞', '‚è±Ô∏è', '‚è≤Ô∏è', 'üï∞Ô∏è', 'üïõ', 'üïß', 'üïê', 'üïú', 'üïë', 'üïù', 'üïí', 'üïû', 'üïì', 'üïü', 'üïî', 'üï†', 'üïï', 'üï°', 'üïñ', 'üï¢', 'üïó', 'üï£', 'üïò', 'üï§', 'üïô', 'üï•', 'üïö', 'üï¶', 'üïô', 'üï•', 'üïö', 'üï¶', 'üïõ', 'üïß', 'üåç', 'üåé', 'üåè', 'üåê', 'üó∫Ô∏è', 'üóæ', 'üß≠', 'üèîÔ∏è', '‚õ∞Ô∏è', 'üåã', 'üóª', 'üèïÔ∏è', 'üèñÔ∏è', 'üèúÔ∏è', 'üèùÔ∏è', 'üèûÔ∏è', 'üèüÔ∏è', 'üèõÔ∏è', 'üèóÔ∏è', 'üß±', 'ü™®', 'ü™µ', 'üõñ', 'üèòÔ∏è', 'üèöÔ∏è', 'üè†', 'üè°', 'üè¢', 'üè£', 'üè§', 'üè•', 'üè¶', 'üè®', 'üè©', 'üè™', 'üè´', 'üè¨', 'üè≠', 'üèØ', 'üè∞', 'üíí', 'üóº', 'üóΩ', '‚õ™', 'üïå', 'üõï', 'üïç', '‚õ©Ô∏è', 'üïã', '‚õ≤', '‚õ∫', 'üåÅ', 'üåÉ', 'üèôÔ∏è', 'üåÑ', 'üåÖ', 'üåÜ', 'üåá', 'üåâ', '‚ô®Ô∏è', 'üé†', 'üé°', 'üé¢', 'üíà', 'üé™', 'üöÇ', 'üöÉ', 'üöÑ', 'üöÖ', 'üöÜ', 'üöá', 'üöà', 'üöâ', 'üöä', 'üöù', 'üöû', 'üöã', 'üöå', 'üöç', 'üöé', 'üöê', 'üöë', 'üöí', 'üöì', 'üöî', 'üöï', 'üöñ', 'üöó', 'üöò', 'üöô', 'üõª', 'üöö', 'üöõ', 'üöú', 'üèéÔ∏è', 'üèçÔ∏è', 'üõµ', 'ü¶Ω', 'ü¶º', 'üõ¥', 'üö≤', 'üõ∂', 'üõ•Ô∏è', 'üöÅ', 'üõ©Ô∏è', '‚úàÔ∏è', 'üõ´', 'üõ¨', 'ü™Ç', 'üí∫', 'üöÄ', 'üõ∏', 'üöÅ', 'üõ©Ô∏è', '‚úàÔ∏è', 'üõ´', 'üõ¨', 'ü™Ç', 'üí∫', 'üöÄ', 'üõ∏'],
      objects: ['üí°', 'üî¶', 'üïØÔ∏è', 'ü™î', 'üßØ', 'üõ¢Ô∏è', 'üí∏', 'üíµ', 'üí¥', 'üí∂', 'üí∑', 'ü™ô', 'üí∞', 'üí≥', 'üíé', '‚öñÔ∏è', 'ü™ú', 'üß∞', 'ü™õ', 'üîß', 'üî®', '‚öíÔ∏è', 'üõ†Ô∏è', '‚õèÔ∏è', 'ü™ö', 'üî©', '‚öôÔ∏è', 'ü™§', 'üß±', '‚õìÔ∏è', 'ü™ù', 'üß≤', 'üî´', 'üí£', 'ü™É', 'üèπ', 'üõ°Ô∏è', 'ü™Ñ', 'üîÆ', 'üßø', 'ü™¨', 'üìø', 'üß∏', 'ü™Ü', 'ü™Ö', 'ü™©', 'ü™û', 'ü™ü', 'ü™†', 'ü™°', 'ü™¢', 'üß∂', 'ü™£', 'ü™§', 'ü™•', 'ü™¶', 'ü™ß', '‚ö∞Ô∏è', 'ü™®', 'ü™©', 'ü™™', 'ü™´', 'ü™¨', 'ü™≠', 'ü™Æ', 'ü™Ø', 'ü™∞', 'ü™±', 'ü™≤', 'ü™≥', 'ü™¥', 'ü™µ', 'ü™∂', 'ü™∑', 'ü™∏', 'ü™π', 'ü™∫', 'ü™ª', 'ü™º', 'ü™Ω', 'ü™æ', 'ü™ø', 'ü´Ä', 'ü´Å', 'üß†', 'ü´Ç', 'ü´É', 'ü´Ñ', 'ü´Ö', 'ü´Ü', 'ü´á', 'ü´à', 'ü´â', 'ü´ä', 'ü´ã', 'ü´å', 'ü´ç', 'ü´é', 'ü´è', 'ü´ê', 'ü´ë', 'ü´í', 'ü´ì', 'ü´î', 'ü´ï', 'ü´ñ'],
      symbols: ['‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üíü', '‚òÆÔ∏è', '‚úùÔ∏è', '‚ò™Ô∏è', 'üïâÔ∏è', '‚ò∏Ô∏è', '‚ú°Ô∏è', 'üîØ', 'üïé', '‚òØÔ∏è', '‚ò¶Ô∏è', 'üõê', '‚õé', '‚ôà', '‚ôâ', '‚ôä', '‚ôã', '‚ôå', '‚ôç', '‚ôé', '‚ôè', '‚ôê', '‚ôë', '‚ôí', '‚ôì', 'üÜî', '‚öõÔ∏è', 'üâë', '‚ò¢Ô∏è', '‚ò£Ô∏è', 'üì¥', 'üì≥', 'üà∂', 'üàö', 'üà∏', 'üà∫', 'üà∑Ô∏è', '‚ú¥Ô∏è', 'üÜö', 'üíÆ', 'üâê', '„äôÔ∏è', '„äóÔ∏è', 'üà¥', 'üàµ', 'üàπ', 'üà≤', 'üÖ∞Ô∏è', 'üÖ±Ô∏è', 'üÜé', 'üÜë', 'üÖæÔ∏è', 'üÜò', '‚ùå', '‚≠ï', 'üõë', '‚õî', 'üìõ', 'üö´', 'üíØ', 'üí¢', '‚ô®Ô∏è', 'üö∑', 'üöØ', 'üö≥', 'üö±', 'üîû', 'üìµ', 'üö≠', '‚ùó', '‚ùï', '‚ùì', '‚ùî', '‚ÄºÔ∏è', '‚ÅâÔ∏è', 'üîÖ', 'üîÜ', '„ÄΩÔ∏è', '‚ö†Ô∏è', 'üö∏', 'üî±', '‚öúÔ∏è', 'üî∞', '‚ôªÔ∏è', '‚úÖ', 'üàØ', 'üíπ', '‚ùáÔ∏è', '‚ú≥Ô∏è', '‚ùé', 'üåê', 'üí†', '‚ìÇÔ∏è', 'üåÄ', 'üí§', 'üèß', 'üöæ', '‚ôø', 'üÖøÔ∏è', 'üõó', 'üõÇ', 'üõÉ', 'üõÑ', 'üõÖ', 'üöπ', 'üö∫', 'üöº', 'üöª', 'üöÆ', 'üé¶', 'üì∂', 'üàÅ', 'üî£', '‚ÑπÔ∏è', 'üî§', 'üî°', 'üî†', 'üÜñ', 'üÜó', 'üÜô', 'üÜí', 'üÜï', 'üÜì', '0Ô∏è‚É£', '1Ô∏è‚É£', '2Ô∏è‚É£', '3Ô∏è‚É£', '4Ô∏è‚É£', '5Ô∏è‚É£', '6Ô∏è‚É£', '7Ô∏è‚É£', '8Ô∏è‚É£', '9Ô∏è‚É£', 'üîü', 'üî¢', '#Ô∏è‚É£', '*Ô∏è‚É£', '‚èèÔ∏è', '‚ñ∂Ô∏è', '‚è∏Ô∏è', '‚èØÔ∏è', '‚èπÔ∏è', '‚è∫Ô∏è', '‚è≠Ô∏è', '‚èÆÔ∏è', '‚è©', '‚è™', '‚è´', '‚è¨', '‚óÄÔ∏è', 'üîº', 'üîΩ', '‚û°Ô∏è', '‚¨ÖÔ∏è', '‚¨ÜÔ∏è', '‚¨áÔ∏è', '‚ÜóÔ∏è', '‚ÜòÔ∏è', '‚ÜôÔ∏è', '‚ÜñÔ∏è', '‚ÜïÔ∏è', '‚ÜîÔ∏è', '‚Ü™Ô∏è', '‚Ü©Ô∏è', '‚§¥Ô∏è', '‚§µÔ∏è', 'üîÄ', 'üîÅ', 'üîÇ', 'üîÑ', 'üîÉ', 'üéµ', 'üé∂', '‚ûï', '‚ûñ', '‚ûó', '‚úñÔ∏è', '‚ôæÔ∏è', 'üí≤', 'üí±', '‚Ñ¢Ô∏è', '¬©Ô∏è', '¬ÆÔ∏è', 'üëÅÔ∏è‚Äçüó®Ô∏è', 'üîö', 'üîô', 'üîõ', 'üîù', 'üîú', '„Ä∞Ô∏è', '‚û∞', '‚ûø', '‚úîÔ∏è', '‚òëÔ∏è', 'üîò', 'üî¥', 'üü†', 'üü°', 'üü¢', 'üîµ', 'üü£', '‚ö´', '‚ö™', 'üü§', 'üî∫', 'üîª', 'üî∏', 'üîπ', 'üî∂', 'üî∑', 'üî≥', 'üî≤', '‚ñ™Ô∏è', '‚ñ´Ô∏è', '‚óæ', '‚óΩ', '‚óºÔ∏è', '‚óªÔ∏è', 'üü•', 'üüß', 'üü®', 'üü©', 'üü¶', 'üü™', '‚¨õ', '‚¨ú', 'üü´', 'üîà', 'üîá', 'üîâ', 'üîä', 'üîî', 'üîï', 'üì£', 'üì¢', 'üí¨', 'üí≠', 'üóØÔ∏è', '‚ô†Ô∏è', '‚ô£Ô∏è', '‚ô•Ô∏è', '‚ô¶Ô∏è', 'üÉè', 'üé¥', 'üÄÑ', 'üïê', 'üïë', 'üïí', 'üïì', 'üïî', 'üïï', 'üïñ', 'üïó', 'üïò', 'üïô', 'üïö', 'üïõ', 'üïú', 'üïù', 'üïû', 'üïü', 'üï†', 'üï°', 'üï¢', 'üï£', 'üï§', 'üï•', 'üï¶', 'üïß'],
      flags: ['üèÅ', 'üö©', 'üéå', 'üè¥', 'üè≥Ô∏è', 'üè≥Ô∏è‚Äçüåà', 'üè¥‚Äç‚ò†Ô∏è', 'üá¶üá®', 'üá¶üá©', 'üá¶üá´', 'üá¶üá¨', 'üá¶üá∑', 'üá¶üá≤', 'üá¶üáº', 'üá¶üá∫', 'üá¶üáπ', 'üá¶üáø', 'üáßüá∏', 'üáßüá≠', 'üáßüá©', 'üáßüáØ', 'üáßüá≤', 'üáßüá≥', 'üáßüá¥', 'üáßüá∂', 'üáßüá∑', 'üáßüá∏', 'üáßüáπ', 'üáßüáª', 'üáßüáº', 'üáßüáæ', 'üáßüáø', 'üá®üá¶', 'üá®üá®', 'üá®üá©', 'üá®üá´', 'üá®üá¨', 'üá®üá≠', 'üá®üáÆ', 'üá®üá∞', 'üá®üá±', 'üá®üá≤', 'üá®üá≥', 'üá®üá¥', 'üá®üáµ', 'üá®üá∑', 'üá®üá∫', 'üá®üáª', 'üá®üáº', 'üá®üáΩ', 'üá®üáæ', 'üá®üáø', 'üá©üá™', 'üá©üáØ', 'üá©üá∞', 'üá©üá≤', 'üá©üá¥', 'üá©üáø', 'üá™üá®', 'üá™üá™', 'üá™üá¨', 'üá™üá≠', 'üá™üá∑', 'üá™üá∏', 'üá™üáπ', 'üá™üá∫', 'üá´üáÆ', 'üá´üáØ', 'üá´üá∞', 'üá´üá≤', 'üá´üá¥', 'üá´üá∑', 'üá¨üá¶', 'üá¨üáß', 'üá¨üá©', 'üá¨üá™', 'üá¨üá´', 'üá¨üá¨', 'üá¨üá≠', 'üá¨üáÆ', 'üá¨üá±', 'üá¨üá≤', 'üá¨üá≥', 'üá¨üáµ', 'üá¨üá∂', 'üá¨üá∑', 'üá¨üá∏', 'üá¨üáπ', 'üá¨üá∫', 'üá¨üáº', 'üá¨üáæ', 'üá≠üá∞', 'üá≠üá≤', 'üá≠üá≥', 'üá≠üá∑', 'üá≠üáπ', 'üá≠üá∫', 'üáÆüá©', 'üáÆüá™', 'üáÆüá±', 'üáÆüá≤', 'üáÆüá≥', 'üáÆüá¥', 'üáÆüá∂', 'üáÆüá∑', 'üáÆüá∏', 'üáÆüáπ', 'üáØüá™', 'üáØüá≤', 'üáØüá¥', 'üáØüáµ', 'üá∞üá™', 'üá∞üá¨', 'üá∞üá≠', 'üá∞üáÆ', 'üá∞üá≤', 'üá∞üá≥', 'üá∞üáµ', 'üá∞üá∑', 'üá∞üáº', 'üá∞üáæ', 'üá∞üáø', 'üá±üá¶', 'üá±üáß', 'üá±üá®', 'üá±üáÆ', 'üá±üá∞', 'üá±üá∑', 'üá±üá∏', 'üá±üáπ', 'üá±üá∫', 'üá±üáª', 'üá±üáæ', 'üá≤üá¶', 'üá≤üá®', 'üá≤üá©', 'üá≤üá™', 'üá≤üá´', 'üá≤üá¨', 'üá≤üá≠', 'üá≤üá∞', 'üá≤üá±', 'üá≤üá≤', 'üá≤üá≥', 'üá≤üá¥', 'üá≤üáµ', 'üá≤üá∂', 'üá≤üá∑', 'üá≤üá∏', 'üá≤üáπ', 'üá≤üá∫', 'üá≤üáª', 'üá≤üáº', 'üá≤üáΩ', 'üá≤üáæ', 'üá≤üáø', 'üá≥üá¶', 'üá≥üá®', 'üá≥üá™', 'üá≥üá´', 'üá≥üá¨', 'üá≥üáÆ', 'üá≥üá±', 'üá≥üá¥', 'üá≥üáµ', 'üá≥üá∑', 'üá≥üá∫', 'üá≥üáø', 'üá¥üá≤', 'üáµüá¶', 'üáµüá™', 'üáµüá´', 'üáµüá¨', 'üáµüá≠', 'üáµüá∞', 'üáµüá±', 'üáµüá≤', 'üáµüá≥', 'üáµüá∑', 'üáµüá∏', 'üáµüáπ', 'üáµüáº', 'üáµüáæ', 'üá∂üá¶', 'üá∑üá™', 'üá∑üá¥', 'üá∑üá∏', 'üá∑üá∫', 'üá∑üáº', 'üá∏üá¶', 'üá∏üáß', 'üá∏üá®', 'üá∏üá©', 'üá∏üá™', 'üá∏üá¨', 'üá∏üá≠', 'üá∏üáÆ', 'üá∏üáØ', 'üá∏üá∞', 'üá∏üá±', 'üá∏üá≤', 'üá∏üá≥', 'üá∏üá¥', 'üá∏üá∑', 'üá∏üá∏', 'üá∏üáπ', 'üá∏üáª', 'üá∏üáΩ', 'üá∏üáæ', 'üá∏üáø', 'üáπüá¶', 'üáπüá®', 'üáπüá©', 'üáπüáØ', 'üáπüá∞', 'üáπüá±', 'üáπüá≤', 'üáπüá≥', 'üáπüá¥', 'üáπüá∑', 'üáπüáπ', 'üáπüáª', 'üáπüáº', 'üáπüáø', 'üá∫üá¶', 'üá∫üá¨', 'üá∫üá≤', 'üá∫üá≥', 'üá∫üá∏', 'üá∫üáæ', 'üá∫üáø', 'üáªüá¶', 'üáªüá®', 'üáªüá™', 'üáªüá¨', 'üáªüáÆ', 'üáªüá≥', 'üáªüá∫', 'üáºüá´', 'üáºüá∏', 'üáæüá™', 'üáæüáπ', 'üáøüá¶', 'üáøüá≤', 'üáøüáº']
    };

    // Toggle emoji picker
    function toggleEmojiPicker() {
      const emojiPicker = document.getElementById('emojiPicker');
      const emojiToggle = document.getElementById('emojiToggle');
      const chatInput = document.getElementById('chatInput');
      const codeInput = document.getElementById('codeInput');
      
      if (emojiPicker.style.display === 'none') {
        emojiPicker.style.display = 'block';
        emojiToggle.classList.add('active');
        loadEmojis('recent');
        document.getElementById('emojiSearch').focus();
      } else {
        emojiPicker.style.display = 'none';
        emojiToggle.classList.remove('active');
        chatInput.focus();
      }
    }

    // Load emojis for a category
    function loadEmojis(category) {
      const emojiGrid = document.getElementById('emojiGrid');
      const emojis = emojiData[category] || emojiData.recent;
      
      emojiGrid.innerHTML = '';
      emojis.forEach(emoji => {
        const button = document.createElement('button');
        button.className = 'emoji-item';
        button.textContent = emoji;
        button.onclick = () => insertEmoji(emoji);
        emojiGrid.appendChild(button);
      });
    }

    // Insert emoji into input
    function insertEmoji(emoji) {
      const chatInput = document.getElementById('chatInput');
      const codeInput = document.getElementById('codeInput');
      const codeToggle = document.getElementById('codeToggle');
      
      if (codeToggle.classList.contains('active')) {
        // Insert into code input
        const start = codeInput.selectionStart;
        const end = codeInput.selectionEnd;
        const text = codeInput.value;
        codeInput.value = text.substring(0, start) + emoji + text.substring(end);
        codeInput.setSelectionRange(start + emoji.length, start + emoji.length);
        codeInput.focus();
      } else {
        // Insert into chat input
        const start = chatInput.selectionStart;
        const end = chatInput.selectionEnd;
        const text = chatInput.value;
        chatInput.value = text.substring(0, start) + emoji + text.substring(end);
        chatInput.setSelectionRange(start + emoji.length, start + emoji.length);
        chatInput.focus();
      }
    }

    // Toggle fullscreen code mode
    function toggleFullscreenCode() {
      const fullscreenCode = document.getElementById('fullscreenCode');
      const fullscreenInput = document.getElementById('fullscreenCodeInput');
      const fullscreenLanguage = document.getElementById('fullscreenLanguageSelect');
      const codeInput = document.getElementById('codeInput');
      const languageSelect = document.getElementById('languageSelect');
      
      // Copy current code and language to fullscreen
      fullscreenInput.value = codeInput.value;
      fullscreenLanguage.value = languageSelect.value;
      
      // Show fullscreen
      fullscreenCode.classList.add('active');
      fullscreenInput.focus();
      
      // Update character and line count
      updateFullscreenStats();
    }

    // Exit fullscreen code mode
    function exitFullscreenCode() {
      const fullscreenCode = document.getElementById('fullscreenCode');
      const fullscreenInput = document.getElementById('fullscreenCodeInput');
      const codeInput = document.getElementById('codeInput');
      
      // Copy code back to regular input
      codeInput.value = fullscreenInput.value;
      
      // Hide fullscreen
      fullscreenCode.classList.remove('active');
    }

    // Send code from fullscreen
    function sendFullscreenCode() {
      const fullscreenInput = document.getElementById('fullscreenCodeInput');
      const fullscreenLanguage = document.getElementById('fullscreenLanguageSelect');
      const codeInput = document.getElementById('codeInput');
      const languageSelect = document.getElementById('languageSelect');
      
      // Copy values to regular inputs
      codeInput.value = fullscreenInput.value;
      languageSelect.value = fullscreenLanguage.value;
      
      // Send the message
      sendMessage();
      
      // Exit fullscreen
      exitFullscreenCode();
    }

    // Clear fullscreen code
    function clearFullscreenCode() {
      if (confirm('Are you sure you want to clear all code?')) {
        document.getElementById('fullscreenCodeInput').value = '';
        updateFullscreenStats();
      }
    }

    // Update fullscreen statistics
    function updateFullscreenStats() {
      const textarea = document.getElementById('fullscreenCodeInput');
      const charCount = document.getElementById('fullscreenCharCount');
      const lineCount = document.getElementById('fullscreenLineCount');
      
      const text = textarea.value;
      const chars = text.length;
      const lines = text.split('\n').length;
      
      charCount.textContent = `${chars} characters`;
      lineCount.textContent = `${lines} line${lines !== 1 ? 's' : ''}`;
    }

    // Copy code to clipboard
    function copyCode(codeElement) {
      const text = codeElement.textContent;
      navigator.clipboard.writeText(text).then(() => {
        const copyBtn = codeElement.parentElement.querySelector('.code-copy');
        const originalText = copyBtn.innerHTML;
        copyBtn.innerHTML = '<i class="fas fa-check"></i>';
        copyBtn.style.color = 'var(--success)';
        
        setTimeout(() => {
          copyBtn.innerHTML = originalText;
          copyBtn.style.color = 'var(--gray)';
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy code:', err);
      });
    }

    // Real-time chat updates
    function setupRealtimeChat() {
      const messagesContainer = document.getElementById('chatMessages');
      
      supabaseClient.channel('public:messages')
        .on(
          'postgres_changes',
          {
            event: 'INSERT',
            schema: 'public',
            table: 'messages'
          },
          async (payload) => {
            // Get user info for the message
            let senderName = 'Unknown';
            let senderRole = 'user';
            try {
              const { data: profile } = await supabaseClient
                .from('profiles')
                .select('username, email, role')
                .eq('id', payload.new.user_id)
                .single();
              
              if (profile) {
                senderName = getUserDisplayName({ email: profile.email }, profile);
                senderRole = profile.role || 'user';
              }
            } catch (err) {
              console.log('Could not fetch sender profile');
            }

            const { data: currentUser } = await supabaseClient.auth.getUser();
            const isCurrentUser = payload.new.user_id === currentUser.user?.id;
            
            const messageElement = document.createElement('div');
            messageElement.className = isCurrentUser 
              ? 'message message-sent fade-in' 
              : 'message message-received fade-in';
            messageElement.setAttribute('data-message-id', payload.new.id);
              
            const displayName = isCurrentUser ? getUserDisplayName(currentUser.user) : senderName;
            const roleDisplay = getUserRoleDisplaySync(null, { role: senderRole });
            
            // Check if message contains code blocks
            if (payload.new.content.includes('```')) {
              messageElement.innerHTML = `
                <div class="message-sender">
                  ${displayName} 
                  <span class="message-role" style="color: ${roleDisplay.color}; font-size: 0.7rem; margin-left: 0.5rem;">
                    ${roleDisplay.emoji} ${roleDisplay.role}
                  </span>
                </div>
                <div class="message-content">
                  ${formatCodeMessage(payload.new.content)}
                  ${isCurrentUser ? `<button class="message-delete" onclick="deleteMessage('${payload.new.id}')" title="Delete message">
                    <i class="fas fa-times"></i>
                  </button>` : ''}
                </div>
                <div class="message-time">${formatTime(new Date(payload.new.sent_at))}</div>
              `;
            } else {
              messageElement.innerHTML = `
                <div class="message-sender">
                  ${displayName} 
                  <span class="message-role" style="color: ${roleDisplay.color}; font-size: 0.7rem; margin-left: 0.5rem;">
                    ${roleDisplay.emoji} ${roleDisplay.role}
                  </span>
                </div>
                <div class="message-content">
                  ${payload.new.content}
                  ${isCurrentUser ? `<button class="message-delete" onclick="deleteMessage('${payload.new.id}')" title="Delete message">
                    <i class="fas fa-times"></i>
                  </button>` : ''}
                </div>
                <div class="message-time">${formatTime(new Date(payload.new.sent_at))}</div>
              `;
            }
            
            messagesContainer.appendChild(messageElement);
            smoothScrollToBottom(messagesContainer);
          }
        )
        .on(
          'postgres_changes',
          {
            event: 'DELETE',
            schema: 'public',
            table: 'messages'
          },
          (payload) => {
            console.log('DELETE event received for message:', payload.old.id);
            // Remove deleted message from UI
            const messageElement = document.querySelector(`[data-message-id="${payload.old.id}"]`);
            if (messageElement) {
              console.log('Removing message element from UI:', payload.old.id);
              messageElement.style.opacity = '0';
              messageElement.style.transform = 'translateX(20px)';
              setTimeout(() => {
                messageElement.remove();
              }, 300);
            } else {
              console.log('Message element not found in DOM for deletion:', payload.old.id);
            }
          }
        )
        .subscribe((status) => {
          console.log('Realtime chat subscription status:', status);
        });
    }

    // Load initial messages
    async function loadMessages() {
      try {
        const { data: messages, error } = await supabaseClient
          .from('messages')
          .select('*')
          .order('sent_at', { ascending: true })
          .limit(50);

        if (error) {
          console.error('Error loading messages:', error);
          return;
        }

        const messagesContainer = document.getElementById('chatMessages');
        messagesContainer.innerHTML = '';

        const { data: { user } } = await supabaseClient.auth.getUser();

        // Get all unique user IDs from messages
        const userIds = [...new Set(messages.map(msg => msg.user_id))];
        
        // Fetch user profiles in batch (including roles)
        let userProfiles = {};
        if (userIds.length > 0) {
          try {
            const { data: profiles } = await supabaseClient
              .from('profiles')
              .select('id, username, email, role')
              .in('id', userIds);
            
            if (profiles) {
              profiles.forEach(profile => {
                userProfiles[profile.id] = profile;
              });
            }
          } catch (err) {
            console.log('Could not fetch user profiles, using fallback');
          }
        }

        messages.forEach(msg => {
          const isCurrentUser = msg.user_id === user?.id;
          const messageElement = document.createElement('div');
          
          messageElement.className = isCurrentUser 
            ? 'message message-sent fade-in' 
            : 'message message-received fade-in';
          messageElement.setAttribute('data-message-id', msg.id);
            
          let senderName = 'Unknown';
          let senderRole = 'user';
          if (isCurrentUser) {
            senderName = getUserDisplayName(user);
            // For current user, we'll get the role from the profile we already fetched
            const currentProfile = userProfiles[user.id];
            senderRole = currentProfile?.role || 'user';
          } else {
            const profile = userProfiles[msg.user_id];
            senderName = getUserDisplayName({ email: profile?.email }, profile);
            senderRole = profile?.role || 'user';
          }
          
          const roleDisplay = getUserRoleDisplaySync(null, { role: senderRole });
          
          // Check if message contains code blocks
          if (msg.content.includes('```')) {
            messageElement.innerHTML = `
              <div class="message-sender">
                ${senderName} 
                <span class="message-role" style="color: ${roleDisplay.color}; font-size: 0.7rem; margin-left: 0.5rem;">
                  ${roleDisplay.emoji} ${roleDisplay.role}
                </span>
              </div>
              <div class="message-content">
                ${formatCodeMessage(msg.content)}
                ${isCurrentUser ? `<button class="message-delete" onclick="deleteMessage('${msg.id}')" title="Delete message">
                  <i class="fas fa-times"></i>
                </button>` : ''}
              </div>
              <div class="message-time">${formatTime(new Date(msg.sent_at))}</div>
            `;
          } else {
            messageElement.innerHTML = `
              <div class="message-sender">
                ${senderName} 
                <span class="message-role" style="color: ${roleDisplay.color}; font-size: 0.7rem; margin-left: 0.5rem;">
                  ${roleDisplay.emoji} ${roleDisplay.role}
                </span>
              </div>
              <div class="message-content">
                ${msg.content}
                ${isCurrentUser ? `<button class="message-delete" onclick="deleteMessage('${msg.id}')" title="Delete message">
                  <i class="fas fa-times"></i>
                </button>` : ''}
              </div>
              <div class="message-time">${formatTime(new Date(msg.sent_at))}</div>
            `;
          }
          
          messagesContainer.appendChild(messageElement);
        });

        smoothScrollToBottom(messagesContainer);
      } catch (err) {
        console.error('Error in loadMessages:', err);
      }
    }



    // Helper functions
    function getFileIcon(filetype) {
      const typeMap = {
        'pdf': 'fa-file-pdf',
        'doc': 'fa-file-word',
        'docx': 'fa-file-word',
        'ppt': 'fa-file-powerpoint',
        'pptx': 'fa-file-powerpoint',
        'xls': 'fa-file-excel',
        'xlsx': 'fa-file-excel',
        'jpg': 'fa-file-image',
        'jpeg': 'fa-file-image',
        'png': 'fa-file-image',
        'gif': 'fa-file-image',
        'mp4': 'fa-file-video',
        'mov': 'fa-file-video',
        'mp3': 'fa-file-audio',
        'wav': 'fa-file-audio',
        'zip': 'fa-file-archive',
        'rar': 'fa-file-archive'
      };

      if (!filetype) return 'fa-file';
      const ext = filetype.split('/').pop();
      return typeMap[ext] || 'fa-file';
    }

    function formatTime(date) {
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Get user display name (first name or username)
    function getUserDisplayName(user, profile = null) {
      if (profile?.username) {
        return getFirstName(profile.username);
      } else if (user?.email) {
        return getFirstName(user.email);
      }
      return 'User';
    }

    // Get user role with styling (updated for new role system)
    async function getUserRoleDisplay(user, profile = null) {
      let role = 'user';
      let color = 'var(--gray)';
      let emoji = 'üë§';
      
      if (profile?.role) {
        // Use profile role if available
        role = profile.role;
      } else if (user?.id) {
        // Fetch role from database
        try {
          const { data: roleDetails, error } = await supabaseClient.rpc('get_user_role_details', {
            user_uuid: user.id
          });
          
          if (!error && roleDetails && roleDetails.length > 0) {
            const details = roleDetails[0];
            role = details.role_name;
            color = details.color;
            emoji = details.emoji;
          }
        } catch (err) {
          console.log('Could not fetch role details, using default');
        }
      }
      
      return {
        role: role,
        color: color,
        emoji: emoji
      };
    }

    // Synchronous version for immediate use
    function getUserRoleDisplaySync(user, profile = null) {
      let role = 'user';
      let color = 'var(--gray)';
      let emoji = 'üë§';
      
      if (profile?.role) {
        role = profile.role;
      }
      
      // Map role names to colors and emojis
      const roleMap = {
        'admin': { color: '#ef4444', emoji: 'üëë' },
        'moderator': { color: '#f59e0b', emoji: 'üõ°Ô∏è' },
        'vip': { color: '#10b981', emoji: '‚≠ê' },
        'user': { color: '#6366f1', emoji: 'üë§' }
      };
      
      if (roleMap[role]) {
        color = roleMap[role].color;
        emoji = roleMap[role].emoji;
      }
      
      return {
        role: role,
        color: color,
        emoji: emoji
      };
    }

    // Check if user is admin
    async function isUserAdmin(userId) {
      try {
        const { data: roleDetails, error } = await supabaseClient.rpc('get_user_role_details', {
          user_uuid: userId
        });
        
        if (!error && roleDetails && roleDetails.length > 0) {
          return roleDetails[0].role_name === 'admin';
        }
      } catch (err) {
        console.log('Could not check admin status');
      }
      return false;
    }

    // Load role management interface
    async function loadRoleManagement() {
      try {
        console.log('Loading role management...');
        
        // Load roles
        const { data: roles, error: rolesError } = await supabaseClient
          .from('roles')
          .select('*')
          .order('id');

        console.log('Roles query result:', { roles, rolesError });

        if (rolesError) {
          console.error('Roles query error:', rolesError);
          throw rolesError;
        }

        if (!roles || roles.length === 0) {
          console.log('No roles found in database');
          const rolesTableBody = document.getElementById('rolesTableBody');
          rolesTableBody.innerHTML = `
            <tr>
              <td colspan="5" style="text-align: center; color: var(--gray);">
                No roles found. Please add some roles first.
              </td>
            </tr>
          `;
        } else {
          console.log(`Found ${roles.length} roles:`, roles);
          
          const rolesTableBody = document.getElementById('rolesTableBody');
          rolesTableBody.innerHTML = '';

          roles.forEach(role => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td><strong>${role.name || 'N/A'}</strong></td>
              <td>${role.display_name || 'N/A'}</td>
              <td>
                <div class="color-preview" style="background-color: ${role.color || '#6366f1'}; width: 20px; height: 20px; border-radius: 4px; display: inline-block; margin-right: 8px;"></div>
                ${role.color || '#6366f1'}
              </td>
              <td>
                <span class="emoji-preview">${role.emoji || 'üë§'}</span>
              </td>
              <td>
                <div class="admin-actions">
                  <button class="btn btn-outline btn-sm" onclick="editRole(${role.id})">
                    <i class="fas fa-edit"></i>
                  </button>
                  ${role.name !== 'admin' ? `
                    <button class="btn btn-danger btn-sm" onclick="deleteRole(${role.id})">
                      <i class="fas fa-trash"></i>
                    </button>
                  ` : ''}
                </div>
              </td>
            `;
            rolesTableBody.appendChild(row);
          });
        }

        // Load ALL users with their role information
        let allUsers = [];
        let usersError = null;
        
        try {
          // Get all users from profiles table (client-side approach)
          const { data: profiles, error: profilesError } = await supabaseClient
            .from('profiles')
            .select('*')
            .order('created_at', { ascending: false });
          
          if (profilesError) {
            usersError = profilesError;
          } else if (profiles) {
            // Get all user roles with error handling
            let roleMap = {};
            try {
              // Try the complex query first
              const { data: userRoles, error: rolesError } = await supabaseClient
                .from('user_roles')
                .select(`
                  user_id,
                  roles(id, name, display_name, color, emoji)
                `);
              
              if (!rolesError && userRoles) {
                userRoles.forEach(userRole => {
                  roleMap[userRole.user_id] = userRole.roles;
                });
                console.log('Successfully loaded user roles:', userRoles.length);
              } else {
                console.log('Complex query failed, trying simple approach:', rolesError);
                // Fallback: Try simple queries
                await loadUserRolesSimple();
              }
            } catch (roleErr) {
              console.log('Complex query error, trying simple approach:', roleErr);
              // Fallback: Try simple queries
              await loadUserRolesSimple();
            }
            
            // Fallback function for simple role loading
            async function loadUserRolesSimple() {
              try {
                // Get user_roles and roles separately
                const { data: userRoles, error: userRolesError } = await supabaseClient
                  .from('user_roles')
                  .select('user_id, role_id');
                
                const { data: roles, error: rolesError } = await supabaseClient
                  .from('roles')
                  .select('id, name, display_name, color, emoji');
                
                if (!userRolesError && !rolesError && userRoles && roles) {
                  // Create a map of roles by ID
                  const rolesById = {};
                  roles.forEach(role => {
                    rolesById[role.id] = role;
                  });
                  
                  // Map user roles
                  userRoles.forEach(userRole => {
                    const role = rolesById[userRole.role_id];
                    if (role) {
                      roleMap[userRole.user_id] = role;
                    }
                  });
                  
                  console.log('Successfully loaded user roles (simple method):', userRoles.length);
                } else {
                  console.log('Simple method also failed, using default roles');
                }
              } catch (simpleErr) {
                console.log('Simple method error, using default roles:', simpleErr);
              }
            }
            
            // Combine profiles with roles
            allUsers = profiles.map(profile => {
              const role = roleMap[profile.id];
              
              return {
                id: profile.id,
                email: profile.email,
                username: profile.username || profile.email?.split('@')[0] || 'Unknown',
                created_at: profile.created_at,
                role_name: role?.name || 'user',
                role_display_name: role?.display_name || 'User',
                role_color: role?.color || '#6366f1',
                role_emoji: role?.emoji || 'üë§',
                has_assigned_role: !!role
              };
            });
          }
        } catch (err) {
          console.error('Error loading users:', err);
          usersError = err;
        }

        if (usersError) {
          console.error('Users query error:', usersError);
          throw usersError;
        }

        const userRolesTableBody = document.getElementById('userRolesTableBody');
        userRolesTableBody.innerHTML = '';

        if (allUsers && allUsers.length > 0) {
          console.log(`Found ${allUsers.length} users:`, allUsers);
          
          allUsers.forEach(user => {
            const row = document.createElement('tr');
            const joinDate = user.created_at ? new Date(user.created_at).toLocaleDateString() : 'Unknown';
            
            row.innerHTML = `
              <td>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <div class="user-avatar" style="width: 24px; height: 24px; font-size: 0.7rem;">
                    ${user.username?.charAt(0).toUpperCase() || 'U'}
                  </div>
                  <div>
                    <div style="font-weight: 500; color: var(--light);">${user.username || 'Unknown'}</div>
                    <div style="font-size: 0.7rem; color: var(--gray);">Joined: ${joinDate}</div>
                  </div>
                </div>
              </td>
              <td>${user.email || 'No email'}</td>
              <td>
                <span class="role-badge" style="color: ${user.role_color}; background-color: ${user.role_color}20;">
                  ${user.role_emoji} ${user.role_display_name}
                </span>
                ${!user.has_assigned_role ? '<span style="font-size: 0.7rem; color: var(--gray); margin-left: 0.5rem;">(default)</span>' : ''}
              </td>
              <td>
                <div class="admin-actions">
                  <button class="btn btn-outline btn-sm" onclick="changeUserRole('${user.id}')" title="Change Role">
                    <i class="fas fa-user-edit"></i>
                  </button>
                  ${user.has_assigned_role ? `
                    <button class="btn btn-danger btn-sm" onclick="removeUserRole('${user.id}')" title="Remove Role">
                      <i class="fas fa-user-minus"></i>
                    </button>
                  ` : `
                    <button class="btn btn-secondary btn-sm" onclick="assignDefaultRole('${user.id}')" title="Assign Default Role">
                      <i class="fas fa-user-plus"></i>
                    </button>
                  `}
                </div>
              </td>
            `;
            userRolesTableBody.appendChild(row);
          });
        } else {
          userRolesTableBody.innerHTML = `
            <tr>
              <td colspan="4" style="text-align: center; color: var(--gray);">
                No users found
              </td>
            </tr>
          `;
        }

      } catch (err) {
        console.error('Error loading role management:', err);
        showToast('error', 'Error', 'Failed to load role management data.');
      }
    }

    // Show add role modal
    function showAddRoleModal() {
      const roleName = prompt('Enter role name (e.g., "vip"):');
      if (!roleName) return;

      const displayName = prompt('Enter display name (e.g., "VIP Member"):');
      if (!displayName) return;

      const color = prompt('Enter color (hex code, e.g., "#10b981"):', '#10b981');
      if (!color) return;

      const emoji = prompt('Enter emoji (e.g., "‚≠ê"):', '‚≠ê');
      if (!emoji) return;

      addRole(roleName, displayName, color, emoji);
    }

    // Add new role
    async function addRole(name, displayName, color, emoji) {
      try {
        const { error } = await supabaseClient
          .from('roles')
          .insert({
            name: name.toLowerCase(),
            display_name: displayName,
            color: color,
            emoji: emoji,
            permissions: { "send_messages": true, "upload_files": true }
          });

        if (error) throw error;

        showToast('success', 'Role Added', `Role "${displayName}" has been created successfully!`);
        loadRoleManagement();
      } catch (err) {
        console.error('Error adding role:', err);
        showToast('error', 'Error', 'Failed to add role.');
      }
    }

    // Edit role
    function editRole(roleId) {
      // This would open a more sophisticated modal in a real app
      showToast('info', 'Edit Role', 'Edit functionality would be implemented here.');
    }

    // Delete role
    async function deleteRole(roleId) {
      if (!confirm('Are you sure you want to delete this role? Users with this role will become regular users.')) {
        return;
      }

      try {
        const { error } = await supabaseClient
          .from('roles')
          .delete()
          .eq('id', roleId);

        if (error) throw error;

        showToast('success', 'Role Deleted', 'Role has been deleted successfully!');
        loadRoleManagement();
      } catch (err) {
        console.error('Error deleting role:', err);
        showToast('error', 'Error', 'Failed to delete role.');
      }
    }

    // Change user role
    async function changeUserRole(userId) {
      try {
        // Get available roles
        const { data: roles, error: rolesError } = await supabaseClient
          .from('roles')
          .select('id, name, display_name')
          .order('id');

        if (rolesError) throw rolesError;

        const roleOptions = roles.map(role => `${role.id}: ${role.display_name}`).join('\n');
        const selectedRole = prompt(`Select role ID:\n${roleOptions}`);

        if (!selectedRole) return;

        const roleId = parseInt(selectedRole.split(':')[0]);

        // Remove existing role and assign new one
        await supabaseClient
          .from('user_roles')
          .delete()
          .eq('user_id', userId);

        const { data: currentUser } = await supabaseClient.auth.getUser();
        
        await supabaseClient
          .from('user_roles')
          .insert({
            user_id: userId,
            role_id: roleId,
            assigned_by: currentUser.user.id
          });

        showToast('success', 'Role Updated', 'User role has been updated successfully!');
        loadRoleManagement();
      } catch (err) {
        console.error('Error changing user role:', err);
        showToast('error', 'Error', 'Failed to change user role.');
      }
    }

    // Remove user role
    async function removeUserRole(userId) {
      if (!confirm('Are you sure you want to remove this user\'s role? They will become a regular user.')) {
        return;
      }

      try {
        const { error } = await supabaseClient
          .from('user_roles')
          .delete()
          .eq('user_id', userId);

        if (error) throw error;

        showToast('success', 'Role Removed', 'User role has been removed successfully!');
        loadRoleManagement();
      } catch (err) {
        console.error('Error removing user role:', err);
        showToast('error', 'Error', 'Failed to remove user role.');
      }
    }

    // Assign default role to user
    async function assignDefaultRole(userId) {
      try {
        // Get the default 'user' role
        const { data: defaultRole, error: roleError } = await supabaseClient
          .from('roles')
          .select('id')
          .eq('name', 'user')
          .single();

        if (roleError || !defaultRole) {
          showToast('error', 'Error', 'Default role not found.');
          return;
        }

        // Get current user for assigned_by
        const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
        if (error || !user) {
          showToast('error', 'Error', 'Authentication error.');
          return;
        }

        // Assign the default role
        const { error } = await supabaseClient
          .from('user_roles')
          .insert({
            user_id: userId,
            role_id: defaultRole.id,
            assigned_by: user.id
          });

        if (error) throw error;

        showToast('success', 'Role Assigned', 'Default role has been assigned successfully!');
        loadRoleManagement();
      } catch (err) {
        console.error('Error assigning default role:', err);
        showToast('error', 'Error', 'Failed to assign default role.');
      }
    }

    // Extract first name from full name or email
    function getFirstName(fullName) {
      if (!fullName) return 'User';
      
      // Remove email domain if it's an email
      let name = fullName.split('@')[0];
      
      // Split by common separators and get first part
      const separators = ['.', '_', '-', ' '];
      for (const separator of separators) {
        if (name.includes(separator)) {
          name = name.split(separator)[0];
          break;
        }
      }
      
      // Capitalize first letter
      return name.charAt(0).toUpperCase() + name.slice(1).toLowerCase();
    }

    // Get user avatar initial
    function getUserAvatarInitial(user, profile = null) {
      const displayName = getUserDisplayName(user, profile);
      return displayName.charAt(0).toUpperCase();
    }

    // Toast Notification System
    function showToast(type, title, message, duration = 4000) {
      const toastContainer = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icons = {
        success: 'fas fa-check-circle',
        error: 'fas fa-exclamation-circle',
        info: 'fas fa-info-circle'
      };
      
      toast.innerHTML = `
        <i class="${icons[type]} toast-icon"></i>
        <div class="toast-content">
          <div class="toast-title">${title}</div>
          <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">
          <i class="fas fa-times"></i>
        </button>
      `;
      
      toastContainer.appendChild(toast);
      
      // Auto remove after duration
      setTimeout(() => {
        if (toast.parentElement) {
          toast.style.animation = 'toastSlideOut 0.3s ease-out forwards';
          setTimeout(() => {
            if (toast.parentElement) {
              toast.remove();
            }
          }, 300);
        }
      }, duration);
    }

    // Upload Progress System
    function showUploadProgress() {
      const progressContainer = document.getElementById('uploadProgress');
      const progressFill = document.getElementById('uploadProgressFill');
      const progressText = document.getElementById('uploadProgressText');
      
      progressContainer.style.display = 'block';
      progressFill.style.width = '0%';
      progressText.textContent = 'Preparing upload...';
      
      // Simulate progress (you can replace this with real progress tracking)
      let progress = 0;
      const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress >= 100) {
          progress = 100;
          clearInterval(interval);
          progressText.textContent = 'Upload complete!';
          setTimeout(() => {
            progressContainer.style.display = 'none';
          }, 1000);
        } else {
          progressFill.style.width = progress + '%';
          progressText.textContent = `Uploading... ${Math.round(progress)}%`;
        }
      }, 200);
    }

    // Smooth scroll to bottom
    function smoothScrollToBottom(element) {
      element.scrollTo({
        top: element.scrollHeight,
        behavior: 'smooth'
      });
    }

    // Initialize the app
    document.addEventListener('DOMContentLoaded', async function() {
      // Set current year in footer
      document.getElementById('currentYear').textContent = new Date().getFullYear();

      // Attach logout event listener
      document.getElementById('logoutBtn').addEventListener('click', logout);

      // Check auth status
      const { data: { user }, error: authError } = await supabaseClient.auth.getUser();
      if (authError || !user) {
        window.location.href = "login.html";
        return;
      }

      // Set user info in header
      let profile = null;
      try {
        const { data: profileData, error: profileError } = await supabaseClient
          .from('profiles')
          .select('username')
          .eq('id', user.id)
          .single();
        
        if (!profileError) {
          profile = profileData;
        }
      } catch (err) {
        console.log('Profile not found, using email as fallback');
      }

      const userAvatar = document.getElementById('userAvatar');
      const usernameSpan = document.getElementById('username');
      
      const displayName = getUserDisplayName(user, profile);
      const avatarInitial = getUserAvatarInitial(user, profile);
      
      userAvatar.textContent = avatarInitial;
      usernameSpan.textContent = displayName;

      // Set up event listeners
      document.getElementById('chatInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      document.getElementById('codeInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.ctrlKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // Add file input change listener for preview
      document.getElementById('fileInput').addEventListener('change', updateFilePreview);

      // Add code toggle listener
      document.getElementById('codeToggle').addEventListener('click', toggleCodeMode);

      // Add fullscreen toggle listener
      document.getElementById('fullscreenToggle').addEventListener('click', toggleFullscreenCode);

      // Add emoji picker listeners
      document.getElementById('emojiToggle').addEventListener('click', toggleEmojiPicker);
      
      // Emoji category switching
      document.querySelectorAll('.emoji-category').forEach(button => {
        button.addEventListener('click', function() {
          // Remove active class from all categories
          document.querySelectorAll('.emoji-category').forEach(btn => btn.classList.remove('active'));
          // Add active class to clicked category
          this.classList.add('active');
          // Load emojis for selected category
          loadEmojis(this.dataset.category);
        });
      });

      // Emoji search functionality
      document.getElementById('emojiSearch').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const emojiItems = document.querySelectorAll('.emoji-item');
        
        emojiItems.forEach(item => {
          const emoji = item.textContent;
          if (emoji.includes(searchTerm) || searchTerm === '') {
            item.style.display = 'flex';
          } else {
            item.style.display = 'none';
          }
        });
      });

      // Add fullscreen textarea listeners
      document.getElementById('fullscreenCodeInput').addEventListener('input', updateFullscreenStats);
      document.getElementById('fullscreenCodeInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.ctrlKey) {
          e.preventDefault();
          sendFullscreenCode();
        } else if (e.key === 's' && e.ctrlKey) {
          e.preventDefault();
          // Save draft functionality could be added here
          console.log('Draft saved (placeholder)');
        }
      });

      // Load initial data
      loadFiles();
      loadMessages();
      setupRealtimeChat();

      // Check if user is admin and show admin section
      const isAdmin = await isUserAdmin(user.id);
      if (isAdmin) {
        document.getElementById('adminSection').style.display = 'block';
        loadRoleManagement();
      }

      // Show welcome toast
      showToast('success', 'Welcome to Chill Space! üéâ', `Hey ${displayName}! Ready to chat and share files?`, 5000);

      // --- Presence (Online Users) ---
      setupPresence(user, profile?.username || user.email || 'User');
    });

    // --- Presence (Online Users) ---
    function setupPresence(currentUser, username) {
      const presenceChannel = supabaseClient.channel('online-users', {
        config: { presence: { key: currentUser.id } }
      });

      presenceChannel
        .on('presence', { event: 'sync' }, () => {
          const state = presenceChannel.presenceState();
          const onlineIds = Object.keys(state);
          updateOnlineList(onlineIds);
        })
        .subscribe(async (status) => {
          if (status === 'SUBSCRIBED') {
            presenceChannel.track({ id: currentUser.id, username });
          }
        });
    }

    function updateOnlineList(onlineIds) {
      if (!onlineIds.length) {
        document.getElementById('membersList').innerHTML = '';
        document.getElementById('onlineCount').textContent = '0 Online';
        return;
      }
      
      // Try to get user roles from the view first
      supabaseClient
        .from('user_role_details')
        .select('user_id, username, email, role_name, role_display_name, role_color, role_emoji')
        .in('user_id', onlineIds)
        .then(({ data: roleData, error: roleError }) => {
          if (roleError) {
            console.log('Could not fetch role details, falling back to profiles');
            // Fallback to profiles table
            supabaseClient
              .from('profiles')
              .select('id, username, email, role')
              .in('id', onlineIds)
              .then(({ data }) => {
                updateMembersList(data, onlineIds);
              });
            return;
          }
          
          // Create a map of user roles
          const userRoles = {};
          if (roleData) {
            roleData.forEach(item => {
              userRoles[item.user_id] = {
                username: item.username,
                email: item.email,
                role: item.role_name,
                roleDisplayName: item.role_display_name,
                roleColor: item.role_color,
                roleEmoji: item.role_emoji
              };
            });
          }
          
          // For users without roles, fetch from profiles
          const usersWithoutRoles = onlineIds.filter(id => !userRoles[id]);
          if (usersWithoutRoles.length > 0) {
            supabaseClient
              .from('profiles')
              .select('id, username, email, role')
              .in('id', usersWithoutRoles)
              .then(({ data: profileData }) => {
                if (profileData) {
                  profileData.forEach(profile => {
                    userRoles[profile.id] = {
                      username: profile.username,
                      email: profile.email,
                      role: profile.role || 'user'
                    };
                  });
                }
                updateMembersList(userRoles, onlineIds);
              });
          } else {
            updateMembersList(userRoles, onlineIds);
          }
        });
    }
    
    function updateMembersList(userRoles, onlineIds) {
      const membersList = document.getElementById('membersList');
      membersList.innerHTML = '';
      
      onlineIds.forEach(userId => {
        const userData = userRoles[userId];
        if (userData) {
          const div = document.createElement('div');
          div.className = 'member';
          const displayName = getUserDisplayName({ email: userData.email }, userData);
          const avatarInitial = getUserAvatarInitial({ email: userData.email }, userData);
          
          // Use role data if available, otherwise use sync function
          let roleDisplay;
          if (userData.roleColor && userData.roleEmoji) {
            roleDisplay = {
              role: userData.roleDisplayName || userData.role,
              color: userData.roleColor,
              emoji: userData.roleEmoji
            };
          } else {
            roleDisplay = getUserRoleDisplaySync(null, userData);
          }
          
          div.innerHTML = `
            <div class="member-avatar">${avatarInitial}</div>
            <div class="member-info">
              <span class="member-name">${displayName}</span>
              <span class="member-role" style="color: ${roleDisplay.color}; font-size: 0.7rem;">
                ${roleDisplay.emoji} ${roleDisplay.role}
              </span>
            </div>
            <span class="member-status online"></span>
          `;
          membersList.appendChild(div);
        }
      });
      
      document.getElementById('onlineCount').textContent = `${onlineIds.length} Online`;
    }

    // File preview functionality
    async function previewFile(fileId, filepath, filename, filetype) {
      try {
        const modal = document.getElementById('filePreviewModal');
        const modalFileName = document.getElementById('modalFileName');
        const modalFileIcon = document.getElementById('modalFileIcon');
        const modalPreviewContent = document.getElementById('modalPreviewContent');
        const modalDownloadBtn = document.getElementById('modalDownloadBtn');

        // Set modal header
        modalFileName.textContent = filename;
        modalFileIcon.className = `fas ${getFileIcon(filetype)}`;

        // Set download button
        modalDownloadBtn.onclick = () => downloadFile(filepath, filename);

        // Show loading
        modalPreviewContent.innerHTML = `
          <div class="preview-unsupported">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading preview...</p>
          </div>
        `;

        // Show modal
        modal.classList.add('active');

        // Handle different file types
        if (filetype.startsWith('image/')) {
          // Image preview
          const { data: imageUrl } = supabaseClient.storage
            .from('files')
            .getPublicUrl(filepath);

          modalPreviewContent.innerHTML = `
            <img src="${imageUrl.publicUrl}" alt="${filename}" class="preview-image">
          `;
        } else if (filetype === 'application/pdf') {
          // PDF preview
          const { data: pdfUrl } = supabaseClient.storage
            .from('files')
            .getPublicUrl(filepath);

          modalPreviewContent.innerHTML = `
            <iframe src="${pdfUrl.publicUrl}" class="preview-pdf"></iframe>
          `;
        } else if (filetype.startsWith('text/') || 
                   filetype === 'application/json' || 
                   filetype === 'application/javascript' ||
                   filetype === 'text/css' ||
                   filetype === 'text/html') {
          // Text file preview
          const { data, error } = await supabaseClient.storage
            .from('files')
            .download(filepath);

          if (error) {
            throw error;
          }

          const text = await data.text();
          modalPreviewContent.innerHTML = `
            <div class="preview-text">${text}</div>
          `;
        } else {
          // Unsupported file type
          modalPreviewContent.innerHTML = `
            <div class="preview-unsupported">
              <i class="fas ${getFileIcon(filetype)}"></i>
              <h3>Preview Not Available</h3>
              <p>This file type cannot be previewed in the browser.</p>
              <p>Click "Download" to save the file to your device.</p>
            </div>
          `;
        }
      } catch (err) {
        console.error('Error previewing file:', err);
        const modalPreviewContent = document.getElementById('modalPreviewContent');
        modalPreviewContent.innerHTML = `
          <div class="preview-unsupported">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Error Loading Preview</h3>
            <p>Unable to load file preview. Please try downloading the file instead.</p>
          </div>
        `;
      }
    }

    function closeFilePreview() {
      const modal = document.getElementById('filePreviewModal');
      modal.classList.remove('active');
    }

    // Close modal when clicking outside
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('filePreviewModal');
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeFilePreview();
        }
      });
    });

    // Format code messages
    function formatCodeMessage(content) {
      // Split content by code blocks
      const parts = content.split(/(```[\s\S]*?```)/);
      
      return parts.map(part => {
        if (part.startsWith('```') && part.endsWith('```')) {
          // Extract language and code
          const codeBlock = part.slice(3, -3);
          const lines = codeBlock.split('\n');
          const language = lines[0].trim();
          const code = lines.slice(1).join('\n');
          
          return `
            <div class="code-block">
              <div class="code-header">
                <span class="code-language">${language}</span>
                <button class="code-copy" onclick="copyCode(this.nextElementSibling)">
                  <i class="fas fa-copy"></i>
                </button>
              </div>
              <div class="code-content">${escapeHtml(code)}</div>
            </div>
          `;
        } else {
          return escapeHtml(part);
        }
      }).join('');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Delete message
    async function deleteMessage(messageId) {
      if (!confirm('Are you sure you want to delete this message?')) {
        return;
      }

      try {
        // Get current user
        const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
        if (userError || !user) {
          showToast('error', 'Authentication Error', 'Please log in to delete messages.');
          return;
        }

        console.log('Attempting to delete message:', messageId, 'for user:', user.id);

        // Show loading toast
        showToast('info', 'Deleting...', 'Removing message...');

        // Delete message from database directly
        console.log('Sending delete request for message:', messageId, 'user:', user.id);
        
        // Convert messageId to number since database uses bigint
        const messageIdNum = parseInt(messageId, 10);
        if (isNaN(messageIdNum)) {
          console.error('Invalid message ID:', messageId);
          showToast('error', 'Delete Failed', 'Invalid message ID.');
          return;
        }
        
        const { data, error } = await supabaseClient
          .from('messages')
          .delete()
          .eq('id', messageIdNum)
          .eq('user_id', user.id);
        
        console.log('Delete response - data:', data, 'error:', error);

        if (error) {
          console.error('Error deleting message:', error);
          console.error('Error details:', {
            message: error.message,
            details: error.details,
            hint: error.hint,
            code: error.code
          });
          showToast('error', 'Delete Failed', 'Error deleting message: ' + error.message);
          return;
        }

        if (data && data.length > 0) {
          console.log('Message deleted successfully from database:', data[0].id);
          showToast('success', 'Message Deleted', 'Message has been removed successfully!');
          
          // Remove the message from UI immediately
          const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
          if (messageElement) {
            messageElement.style.opacity = '0';
            messageElement.style.transform = 'translateX(20px)';
            setTimeout(() => {
              messageElement.remove();
            }, 300);
          }
        } else {
          console.log('No message was deleted - it may have already been deleted or does not exist');
          showToast('error', 'Delete Failed', 'Message not found or already deleted.');
        }
      } catch (err) {
        console.error('Error in deleteMessage:', err);
        showToast('error', 'Delete Error', 'An error occurred while deleting the message. Please try again.');
      }
    }




  </script>
</body>
</html>

